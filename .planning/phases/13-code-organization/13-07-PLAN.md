---
phase: 13-code-organization
plan: 07
type: execute
wave: 4
depends_on: ["13-01", "13-06"]
files_modified:
  - src/cli/mod.rs
  - src/config/mod.rs
  - src/lib.rs
autonomous: false

must_haves:
  truths:
    - All module re-exports verified and working
    - All imports from external code work unchanged
    - Public API surface maintained
    - No breaking changes to existing code
    - Full test suite passes
  artifacts:
    - path: src/lib.rs
      provides: Crate root with verified re-exports
      max_lines: 100
  key_links:
    - from: src/lib.rs
      to: all submodules
      via: pub mod declarations
---

<objective>
Verify all module re-exports and ensure backward compatibility. Run comprehensive tests to confirm refactoring succeeded (ORG-07).

Purpose: Final verification that all code organization changes work correctly. This is a checkpoint plan to ensure no regressions before considering Phase 13 complete.
Output: Verified module structure with all tests passing.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-code-organization/13-CONTEXT.md
@src/lib.rs
@src/cli/mod.rs
@src/config/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify src/lib.rs re-exports</name>
  <files>src/lib.rs</files>
  <action>
Read src/lib.rs and verify it properly re-exports all public modules:

Required exports:
- pub mod cli
- pub mod client
- pub mod config
- pub mod daemon
- pub mod error
- pub mod format
- pub mod ipc
- pub mod output
- pub mod parallel
- pub mod retry
- pub mod shutdown
- pub mod transport

Check that any public items previously exported are still available.

If missing, add the pub mod declarations.
  </action>
  <verify>
grep "^pub mod" src/lib.rs
# Should show all modules
cargo check --lib 2>&1 | grep -c "error"
# Should be 0
  </verify>
  <done>lib.rs properly re-exports all modules</done>
</task>

<task type="auto">
  <name>Task 2: Verify backward compatible imports</name>
  <files>src/lib.rs, src/main.rs, examples/, tests/</files>
  <action>
Verify these import patterns still work:

From external code:
- use mcp_cli_rs::config::Config;
- use mcp_cli_rs::config::load_config;
- use mcp_cli_rs::cli::commands::cmd_list_servers;
- use mcp_cli_rs::error::McpError;
- use mcp_cli_rs::ipc::ProtocolClient;

Search for any external imports in:
- examples/ directory
- tests/ directory
- Any integration tests

Ensure no import paths changed.
  </action>
  <verify>
grep -r "use mcp_cli_rs::" examples/ tests/ 2>/dev/null | head -20
# Check import patterns
grep "mcp_cli_rs::config" tests/*.rs 2>/dev/null | head -5
# Should show imports working
  </verify>
  <done>All external imports still work</done>
</task>

<task type="auto">
  <name>Task 3: Run cargo check on all targets</name>
  <files>All source files</files>
  <action>
Run comprehensive compilation check:

```bash
cargo check --all-targets
cargo check --examples
cargo check --tests
cargo check --benches
```

This verifies:
- Library compiles
- Binary compiles
- All examples compile
- All tests compile
- All benches compile (if any)

Fix any compilation errors that arise.
  </action>
  <verify>
cargo check --all-targets 2>&1 | grep -E "^error" | wc -l
# Should be 0
echo "All targets compile successfully"
  </verify>
  <done>All targets compile without errors</done>
</task>

<task type="auto">
  <name>Task 4: Run clippy checks</name>
  <files>All source files</files>
  <action>
Run clippy to ensure code quality:

```bash
cargo clippy --all-targets -- -D warnings
```

This should produce zero warnings. If there are any warnings:
- Fix them or
- Add appropriate allow attributes with justification

The codebase was at zero clippy warnings before Phase 13, should remain at zero.
  </action>
  <verify>
cargo clippy --all-targets 2>&1 | grep -E "^error" | wc -l
# Should be 0
cargo clippy --all-targets 2>&1 | tail -5
# Should show no warnings or just compilation info
  </verify>
  <done>Zero clippy warnings</done>
</task>

<task type="auto">
  <name>Task 5: Run test suite</name>
  <files>All tests</files>
  <action>
Run the full test suite:

```bash
cargo test
```

This should:
- Compile all tests
- Run all tests
- Show all tests passing

If tests fail:
- Check if imports need updating in tests
- Verify module paths are correct
- Check for any missed function moves

Test coverage should remain the same.
  </action>
  <verify>
cargo test 2>&1 | tail -30
# Should show test results
# Look for: "test result: ok. X passed"
echo $?
# Should be 0
  </verify>
  <done>All tests pass</done>
</task>

<task type="checkpoint:human-verify">
  <name>Task 6: Verify file size requirements</name>
  <files>All refactored files</files>
  <action>
Present final file size report:

```bash
echo "=== Phase 13 File Size Report ==="
echo ""
echo "CLI Modules:"
wc -l src/cli/commands.rs src/cli/list.rs src/cli/info.rs src/cli/call.rs src/cli/search.rs src/cli/daemon_lifecycle.rs src/cli/command_router.rs src/cli/config_setup.rs src/cli/entry.rs src/cli/mod.rs 2>/dev/null

echo ""
echo "Config Modules:"
wc -l src/config/mod.rs src/config/types.rs src/config/parser.rs src/config/validator.rs 2>/dev/null

echo ""
echo "Main Entry:"
wc -l src/main.rs

echo ""
echo "Original sizes for comparison:"
echo "- commands.rs: 1850 lines"
echo "- main.rs: 809 lines"
echo "- config/mod.rs: 432 lines"
```

All files should be under 600 lines.
  </action>
  <verify>
# Check for any files exceeding 600 lines
awk 'NR==FNR{if($1>600) print $2": "$1" lines EXCEEDS 600 LINE LIMIT"; next} {if($1>600) print $2": "$1" lines EXCEEDS 600 LINE LIMIT"}' <(wc -l src/cli/*.rs src/config/*.rs src/main.rs 2>/dev/null)
# Should output nothing
  </verify>
  <done>All files under 600 lines, requirements satisfied</done>
</task>

<task type="auto">
  <name>Task 7: Generate final summary</name>
  <files>All refactored files</files>
  <action>
Generate summary of changes:

1. Calculate line count changes:
   - Original commands.rs: 1850 -> New files total
   - Original main.rs: 809 -> New main.rs
   - Original config/mod.rs: 432 -> New config files total

2. List all new files created

3. List all files modified

4. Verify requirements satisfied:
   - ORG-01: commands.rs split (list, info, call, search, commands)
   - ORG-02: daemon lifecycle extracted
   - ORG-03: command routing extracted
   - ORG-04: config setup extracted
   - ORG-05: entry point extracted
   - ORG-06: config/mod.rs split
   - ORG-07: module re-exports working
   - ORG-08: all files under 600 lines
   - SIZE-02: no file exceeds 600 lines

5. Document any issues encountered
  </action>
  <verify>
# Verify summary data
echo "New files created:"
ls -1 src/cli/list.rs src/cli/info.rs src/cli/call.rs src/cli/search.rs src/cli/daemon_lifecycle.rs src/cli/command_router.rs src/cli/config_setup.rs src/cli/entry.rs src/config/types.rs src/config/parser.rs src/config/validator.rs 2>/dev/null | wc -l
# Should be 11 new files
  </verify>
  <done>Summary generated with all metrics</done>
</task>

</tasks>

<verification>
After all tasks:
- [ ] src/lib.rs properly exports all modules
- [ ] All backward compatible imports work
- [ ] cargo check --all-targets passes
- [ ] cargo clippy shows zero warnings
- [ ] cargo test passes all tests
- [ ] All files under 600 lines
- [ ] Summary document created
</verification>

<success_criteria>
- All module re-exports working
- All compilation checks pass
- All tests pass
- All files under 600 lines
- Phase 13 requirements satisfied
- Ready for Phase 14
</success_criteria>

<output>
After completion, create .planning/phases/13-code-organization/13-07-SUMMARY.md documenting:
- Final verification results
- File size comparison
- Test results
- Requirements status
- Any notes for Phase 14
</output>
