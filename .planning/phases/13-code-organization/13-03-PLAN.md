---
phase: 13-code-organization
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cli/list.rs
  - src/cli/info.rs
  - src/cli/call.rs
  - src/cli/search.rs
  - src/cli/commands.rs
  - src/cli/mod.rs
autonomous: true

must_haves:
  truths:
    - List commands (list_servers) in src/cli/list.rs
    - Info commands (server_info, tool_info) in src/cli/info.rs
    - Call commands (call_tool) in src/cli/call.rs
    - Search commands (search_tools) in src/cli/search.rs
    - commands.rs reduced to orchestration and re-exports only
    - All command functions remain accessible through cli module
    - All tests compile and pass
  artifacts:
    - path: src/cli/list.rs
      provides: cmd_list_servers function
      max_lines: 500
    - path: src/cli/info.rs
      provides: cmd_server_info and cmd_tool_info functions
      max_lines: 400
    - path: src/cli/call.rs
      provides: cmd_call_tool function
      max_lines: 500
    - path: src/cli/search.rs
      provides: cmd_search_tools function
      max_lines: 400
    - path: src/cli/commands.rs
      provides: Module re-exports and shared utilities
      max_lines: 300
  key_links:
    - from: src/cli/mod.rs
      to: src/cli/list.rs
      via: pub mod list
    - from: src/cli/mod.rs
      to: src/cli/info.rs
      via: pub mod info
    - from: src/cli/mod.rs
      to: src/cli/call.rs
      via: pub mod call
    - from: src/cli/mod.rs
      to: src/cli/search.rs
      via: pub mod search
    - from: src/cli/mod.rs
      to: src/cli/commands.rs
      via: pub mod commands
---

<objective>
Split src/cli/commands.rs (1850 lines) into focused modules by command type: list.rs, info.rs, call.rs, search.rs.

Purpose: Reduce file size and create clear separation between different command domains. commands.rs becomes a thin orchestration module with re-exports.
Output: Four new command modules plus reduced commands.rs.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-code-organization/13-CONTEXT.md
@src/cli/commands.rs
@src/cli/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create src/cli/list.rs with list_servers command</name>
  <files>src/cli/list.rs</files>
  <action>
Extract cmd_list_servers and cmd_list_servers_json from commands.rs:

1. Copy the entire cmd_list_servers function (starts around line 40, ~400+ lines)
2. Include cmd_list_servers_json if it exists
3. Include any helper functions specific to list command:
   - format_server_status
   - Any display/formatting helpers
4. Include all required imports

Structure:
```rust
//! List servers and tools command implementation.

use crate::cli::DetailLevel;
use crate::client::ToolInfo;
// ... other imports

pub async fn cmd_list_servers(...) -> Result<()> { ... }
pub async fn cmd_list_servers_json(...) -> Result<()> { ... }
```

Target: ~400-500 lines (from ~485 lines of original function).
  </action>
  <verify>
cat src/cli/list.rs | wc -l
# Should be 300-500 lines
grep -c "pub async fn cmd_list_servers" src/cli/list.rs
# Should be 1 or 2
cargo check --lib 2>&1 | grep -c "error"
# Should be 0
  </verify>
  <done>list.rs created with cmd_list_servers functions</done>
</task>

<task type="auto">
  <name>Task 2: Create src/cli/info.rs with info commands</name>
  <files>src/cli/info.rs</files>
  <action>
Extract from commands.rs:
- cmd_server_info (starts around line 485, ~140 lines)
- cmd_tool_info (starts around line 631, ~260 lines)
- Any helper functions specific to info commands
- Required imports

Structure:
```rust
//! Show server and tool information command implementation.

use crate::daemon::protocol::{ServerInfo, ToolDetailOutput};
// ... other imports

pub async fn cmd_server_info(...) -> Result<()> { ... }
pub async fn cmd_tool_info(...) -> Result<()> { ... }
```

Target: ~300-400 lines.
  </action>
  <verify>
cat src/cli/info.rs | wc -l
# Should be 250-400 lines
grep -c "pub async fn cmd_server_info" src/cli/info.rs
# Should be 1
grep -c "pub async fn cmd_tool_info" src/cli/info.rs
# Should be 1
cargo check --lib 2>&1 | grep -c "error"
# Should be 0
  </verify>
  <done>info.rs created with server_info and tool_info functions</done>
</task>

<task type="auto">
  <name>Task 3: Create src/cli/call.rs with call_tool command</name>
  <files>src/cli/call.rs</files>
  <action>
Extract from commands.rs:
- cmd_call_tool (starts around line 896, ~380 lines)
- Any helper functions specific to call command
- Required imports

Structure:
```rust
//! Execute tool command implementation.

use crate::client::ToolInfo;
use crate::daemon::protocol::{ExecutionMetadata, ToolResult};
// ... other imports

pub async fn cmd_call_tool(...) -> Result<()> { ... }
```

Target: ~350-500 lines.
  </action>
  <verify>
cat src/cli/call.rs | wc -l
# Should be 300-500 lines
grep -c "pub async fn cmd_call_tool" src/cli/call.rs
# Should be 1
cargo check --lib 2>&1 | grep -c "error"
# Should be 0
  </verify>
  <done>call.rs created with call_tool function</done>
</task>

<task type="auto">
  <name>Task 4: Create src/cli/search.rs with search_tools command</name>
  <files>src/cli/search.rs</files>
  <action>
Extract from commands.rs:
- cmd_search_tools (starts around line 1277, remaining ~570 lines)
- Any helper functions specific to search command
- Required imports

Structure:
```rust
//! Search tools by name pattern command implementation.

use crate::daemon::protocol::{SearchMatch, SearchOutput};
// ... other imports

pub async fn cmd_search_tools(...) -> Result<()> { ... }
```

Target: ~400-600 lines.
  </action>
  <verify>
cat src/cli/search.rs | wc -l
# Should be 400-600 lines
grep -c "pub async fn cmd_search_tools" src/cli/search.rs
# Should be 1
cargo check --lib 2>&1 | grep -c "error"
# Should be 0
  </verify>
  <done>search.rs created with search_tools function</done>
</task>

<task type="auto">
  <name>Task 5: Update src/cli/mod.rs to include new modules</name>
  <files>src/cli/mod.rs</files>
  <action>
Update src/cli/mod.rs to declare all new modules:

```rust
pub mod commands;
pub mod daemon;
pub mod filter;
pub mod config_setup;  // from plan 13-02

// New command modules
pub mod list;
pub mod info;
pub mod call;
pub mod search;

// Re-export command functions for backward compatibility
pub use list::{cmd_list_servers, cmd_list_servers_json};
pub use info::{cmd_server_info, cmd_tool_info};
pub use call::cmd_call_tool;
pub use search::cmd_search_tools;
```

This maintains backward compatibility while allowing direct module access.
  </action>
  <verify>
grep -c "pub mod list" src/cli/mod.rs
# Should be 1
grep -c "pub mod info" src/cli/mod.rs
# Should be 1
grep -c "pub mod call" src/cli/mod.rs
# Should be 1
grep -c "pub mod search" src/cli/mod.rs
# Should be 1
cargo check --lib 2>&1 | grep -c "error"
# Should be 0
  </verify>
  <done>cli/mod.rs updated with new module declarations and re-exports</done>
</task>

<task type="auto">
  <name>Task 6: Reduce src/cli/commands.rs to orchestration module</name>
  <files>src/cli/commands.rs</files>
  <action>
Replace src/cli/commands.rs content with:

```rust
//! CLI command orchestration module.
//!
//! This module re-exports command functions from specialized modules
//! for backward compatibility. New code should import directly from
//! the specific command modules (list, info, call, search).

// Re-export all command functions
pub use crate::cli::list::{cmd_list_servers, cmd_list_servers_json};
pub use crate::cli::info::{cmd_server_info, cmd_tool_info};
pub use crate::cli::call::cmd_call_tool;
pub use crate::cli::search::cmd_search_tools;

// Re-export DetailLevel if defined here
pub use crate::cli::{DetailLevel};
```

If there are any shared utilities in commands.rs that don't belong to a specific command:
- Move them to a shared module (e.g., src/cli/util.rs)
- Or keep them in commands.rs if they're small (<100 lines)

The goal is to reduce commands.rs from 1850 lines to under 300 lines.
  </action>
  <verify>
cat src/cli/commands.rs | wc -l
# Should be under 300 lines (was 1850)
grep -c "^pub " src/cli/commands.rs
# Should show only re-exports
cargo check --lib 2>&1 | grep -c "error"
# Should be 0
  </verify>
  <done>commands.rs reduced to re-export module under 300 lines</done>
</task>

<task type="auto">
  <name>Task 7: Verify all imports work and run tests</name>
  <files>src/main.rs, src/cli/*.rs</files>
  <action>
Verify backward compatibility:
1. Check that existing imports still work:
   - `use mcp_cli_rs::cli::commands::cmd_list_servers;`
   - `use mcp_cli_rs::cli::{cmd_list_servers, ...};`
2. Check new direct imports work:
   - `use mcp_cli_rs::cli::list::cmd_list_servers;`

Run full verification:
```bash
cargo check --all-targets
cargo test --no-run
```

Fix any compilation errors by updating imports in main.rs or other files.
  </action>
  <verify>
cargo check --all-targets 2>&1 | grep -E "^error" | wc -l
# Should be 0
cargo test --no-run 2>&1 | tail -5
# Should compile successfully
echo "Line counts after split:"
wc -l src/cli/commands.rs src/cli/list.rs src/cli/info.rs src/cli/call.rs src/cli/search.rs
# All should be under 600 lines
  </verify>
  <done>All imports work, all targets compile, all files under 600 lines</done>
</task>

</tasks>

<verification>
After all tasks:
- [ ] src/cli/list.rs exists with cmd_list_servers (~300-500 lines)
- [ ] src/cli/info.rs exists with server_info and tool_info (~250-400 lines)
- [ ] src/cli/call.rs exists with call_tool (~300-500 lines)
- [ ] src/cli/search.rs exists with search_tools (~400-600 lines)
- [ ] src/cli/commands.rs reduced to re-exports only (<300 lines)
- [ ] src/cli/mod.rs declares all new modules
- [ ] All existing imports still work through re-exports
- [ ] cargo check passes with no errors
- [ ] All split files are under 600 lines
</verification>

<success_criteria>
- commands.rs (1850 lines) split into 5 focused modules
- All new modules under 600 lines
- commands.rs becomes re-export module (<300 lines)
- Backward compatible re-exports in cli/mod.rs
- All code compiles without errors
- Total lines preserved (just reorganized)
</success_criteria>

<output>
After completion, create `.planning/phases/13-code-organization/13-03-SUMMARY.md` documenting:
- Original commands.rs line count (1850)
- New file line counts
- Functions moved to each module
- Any import changes required
</output>
