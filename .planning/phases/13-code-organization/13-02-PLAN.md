---
phase: 13-code-organization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cli/config_setup.rs
  - src/main.rs
autonomous: true

must_haves:
  truths:
    - Config loading setup extracted to src/cli/config_setup.rs
    - main.rs imports from config_setup module
    - Config loading logic is reusable and testable
    - No config loading code duplication in main.rs
  artifacts:
    - path: src/cli/config_setup.rs
      provides: Config loading and initialization logic
      max_lines: 200
  key_links:
    - from: src/main.rs
      to: src/cli/config_setup.rs
      via: use crate::cli::config_setup::*
---

<objective>
Extract config loading and initialization logic from src/main.rs into src/cli/config_setup.rs.

Purpose: Separate config setup concerns from main.rs to reduce its size and improve modularity. This is part of the main.rs refactoring (ORG-04).
Output: New config_setup.rs module with extracted functions.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-code-organization/13-CONTEXT.md
@src/main.rs
@src/cli/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Identify config-related code in main.rs</name>
  <files>src/main.rs</files>
  <action>
Read src/main.rs and identify functions and code blocks related to:
- Config file loading (find_and_load calls)
- Config initialization
- Config path resolution
- Config validation at startup
- Any helper functions that prepare the Config struct

Look for patterns like:
- `find_and_load`
- `load_config`
- Config path construction
- Config error handling during load

Document the line ranges and function signatures that need to be extracted.
  </action>
  <verify>
grep -n "find_and_load\|load_config\|config" src/main.rs | head -30
# Identify config-related code sections
  </verify>
  <done>Identified all config-related functions and code blocks in main.rs</done>
</task>

<task type="auto">
  <name>Task 2: Create src/cli/config_setup.rs with extracted functions</name>
  <files>src/cli/config_setup.rs</files>
  <action>
Create new file src/cli/config_setup.rs with:

```rust
//! Configuration setup and initialization for CLI.
//!
//! Provides functions for loading and validating configuration
//! at application startup.

use crate::config::{find_and_load, load_config, Config};
use crate::error::Result;
use std::path::PathBuf;

/// Load configuration from specified path or find default.
///
/// # Arguments
/// * `config_path` - Optional explicit path to config file
///
/// # Returns
/// * `Ok(Config)` - Loaded configuration
/// * `Err(McpError)` - Config loading/validation error
pub async fn setup_config(config_path: Option<PathBuf>) -> Result<Config> {
    // Extracted from main.rs
}

/// Initialize config with default values if loading fails.
///
/// Used when config file is optional.
pub async fn setup_config_optional(config_path: Option<PathBuf>) -> Result<Config> {
    // Extracted from main.rs
}
```

Extract the actual implementation from main.rs. Target: ~150-200 lines.
  </action>
  <verify>
cat src/cli/config_setup.rs | wc -l
# Should be 100-250 lines
grep -c "pub fn setup_config" src/cli/config_setup.rs
# Should be 1
  </verify>
  <done>config_setup.rs created with extracted config loading functions</done>
</task>

<task type="auto">
  <name>Task 3: Update src/cli/mod.rs to include config_setup module</name>
  <files>src/cli/mod.rs</files>
  <action>
Add to src/cli/mod.rs:

```rust
pub mod config_setup;
```

Place after existing module declarations (commands, daemon, filter).

Ensure the module is properly declared and exported.
  </action>
  <verify>
grep "pub mod config_setup" src/cli/mod.rs
# Should find the line
cargo check --lib 2>&1 | grep -c "error"
# Should be 0
  </verify>
  <done>config_setup module declared in cli/mod.rs</done>
</task>

<task type="auto">
  <name>Task 4: Update main.rs to use config_setup module</name>
  <files>src/main.rs</files>
  <action>
In main.rs:
1. Add import: `use mcp_cli_rs::cli::config_setup::{setup_config, setup_config_optional};`
2. Replace inline config loading code with calls to setup_config functions
3. Remove the extracted functions from main.rs
4. Keep main.rs focused on CLI argument parsing and high-level flow

The goal is to reduce main.rs by ~100-150 lines.

Before making changes, identify the exact lines to remove and verify the replacement calls work correctly.
  </action>
  <verify>
wc -l src/main.rs
# Should show reduced line count (was 809, target reduction 100-150 lines)
cargo check --bin mcp 2>&1 | tail -10
# Should show no errors
  </verify>
  <done>main.rs updated to use config_setup, extracted code removed</done>
</task>

<task type="auto">
  <name>Task 5: Verify compilation and run tests</name>
  <files>src/main.rs, src/cli/config_setup.rs</files>
  <action>
Run full verification:
1. cargo check --all-targets
2. cargo test --no-run (compile tests)
3. Verify no import errors or missing references

If any errors occur, fix them by:
- Adding missing imports
- Updating function signatures
- Fixing module paths
  </action>
  <verify>
cargo check --all-targets 2>&1 | grep -E "^error" | wc -l
# Should be 0
cargo test --no-run 2>&1 | tail -5
# Should compile successfully
  </verify>
  <done>All targets compile successfully with no errors</done>
</task>

</tasks>

<verification>
After all tasks:
- [ ] src/cli/config_setup.rs exists with config loading functions (100-250 lines)
- [ ] src/cli/mod.rs declares config_setup module
- [ ] main.rs imports and uses config_setup functions
- [ ] main.rs reduced by ~100-150 lines
- [ ] cargo check passes with no errors
- [ ] cargo test compiles successfully
</verification>

<success_criteria>
- Config setup logic extracted to dedicated module
- main.rs size reduced
- No functionality lost
- All code compiles and tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/13-code-organization/13-02-SUMMARY.md` documenting:
- Functions extracted
- Line count changes
- Any refactoring decisions made
</output>
