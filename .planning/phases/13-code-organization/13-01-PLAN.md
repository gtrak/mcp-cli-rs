---
phase: 13-code-organization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/config/types.rs
  - src/config/parser.rs
  - src/config/validator.rs
  - src/config/mod.rs
  - src/config/loader.rs
autonomous: true

must_haves:
  truths:
    - Config types exist in src/config/types.rs (ServerConfig, ServerTransport, Config)
    - Config parsing logic exists in src/config/parser.rs
    - Config validation logic exists in src/config/validator.rs
    - src/config/mod.rs re-exports all public items
    - All existing imports continue to work (backward compatible re-exports)
    - All tests compile and pass
  artifacts:
    - path: src/config/types.rs
      provides: Config type definitions and ServerConfig/ServerTransport structs
      max_lines: 200
    - path: src/config/parser.rs
      provides: TOML parsing functions (load_config, find_and_load)
      max_lines: 250
    - path: src/config/validator.rs
      provides: Config validation logic
      max_lines: 150
    - path: src/config/mod.rs
      provides: Module re-exports
      max_lines: 100
  key_links:
    - from: src/config/mod.rs
      to: src/config/types.rs
      via: pub mod types
    - from: src/config/mod.rs
      to: src/config/parser.rs
      via: pub mod parser
    - from: src/config/mod.rs
      to: src/config/validator.rs
      via: pub mod validator
    - from: src/lib.rs
      to: src/config/mod.rs
      via: pub mod config
---

<objective>
Split src/config/mod.rs (432 lines) into focused modules: types.rs, parser.rs, and validator.rs.

Purpose: Reduce file size and create clear separation between data types, parsing logic, and validation. This is the first wave of Phase 13 code organization.
Output: Three new config modules with re-export compatibility maintained.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-code-organization/13-CONTEXT.md
@src/config/mod.rs
@src/config/loader.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create src/config/types.rs with data type definitions</name>
  <files>src/config/types.rs</files>
  <action>
Extract from src/config/mod.rs:
- ServerTransport enum (Stdio and Http variants)
- ServerConfig struct (name, transport, description, allowed_tools, disabled_tools)
- Config struct (servers HashMap, concurrency_limit)
- Any impl blocks for these types
- Required imports (serde, std::collections::HashMap, crate::McpError)

Place at top of file: "//! Configuration types for MCP server definitions."

Keep ONLY type definitions and their inherent implementations. Move ALL parsing and validation logic to other files.

Target: ~150-200 lines.
  </action>
  <verify>
cat src/config/types.rs | wc -l
# Should be 150-250 lines
grep -c "pub struct ServerConfig" src/config/types.rs
# Should be 1
grep -c "pub enum ServerTransport" src/config/types.rs
# Should be 1
grep -c "pub struct Config" src/config/types.rs
# Should be 1
  </verify>
  <done>types.rs exists with ServerConfig, ServerTransport, Config definitions and no parsing logic</done>
</task>

<task type="auto">
  <name>Task 2: Create src/config/parser.rs with TOML parsing functions</name>
  <files>src/config/parser.rs</files>
  <action>
Extract from src/config/loader.rs and src/config/mod.rs:
- load_config function
- find_and_load function
- Any helper functions for file discovery
- Config file path constants (e.g., DEFAULT_CONFIG_PATH)
- Required imports (toml, std::fs, std::path::PathBuf)

Place at top: "//! Configuration file parsing for TOML format."

Import types from crate::config::types::{Config, ServerConfig}.

Target: ~200-250 lines.
  </action>
  <verify>
cat src/config/parser.rs | wc -l
# Should be 150-300 lines
grep -c "pub fn load_config" src/config/parser.rs
# Should be 1
grep -c "pub fn find_and_load" src/config/parser.rs
# Should be 1
  </verify>
  <done>parser.rs exists with load_config and find_and_load functions</done>
</task>

<task type="auto">
  <name>Task 3: Create src/config/validator.rs with validation logic</name>
  <files>src/config/validator.rs</files>
  <action>
Extract from src/config/mod.rs:
- Any validation functions (e.g., validate_config, validate_server_config)
- Validation error types or constants
- Required imports

If no explicit validation functions exist in mod.rs, this file may be minimal (just a placeholder with module doc) or may contain validation extracted from loader.rs.

Place at top: "//! Configuration validation logic."

Target: ~50-150 lines (can be minimal if validation is inline).
  </action>
  <verify>
cat src/config/validator.rs | wc -l
# Should be 30-200 lines
  </verify>
  <done>validator.rs exists (even if minimal placeholder)</done>
</task>

<task type="auto">
  <name>Task 4: Update src/config/mod.rs to re-export from new modules</name>
  <files>src/config/mod.rs</files>
  <action>
Replace entire content of src/config/mod.rs with:

```rust
//! Configuration module for MCP server definitions.
//!
//! This module provides types and utilities for parsing MCP server configurations
//! from TOML files, supporting both stdio and HTTP transports.

pub mod types;
pub mod parser;
pub mod validator;

// Re-export commonly used items for backward compatibility
pub use types::{Config, ServerConfig, ServerTransport};
pub use parser::{load_config, find_and_load};

// Keep loader module as-is (it may have additional utilities)
pub mod loader;
```

DO NOT delete loader.rs - it may have additional utilities. Just ensure mod.rs properly declares all submodules.

Verify no compilation errors after this change.
  </action>
  <verify>
cat src/config/mod.rs | wc -l
# Should be ~20-50 lines
cargo check --lib 2>&1 | head -20
# Should show no errors related to config module
  </verify>
  <done>mod.rs is minimal re-export module under 100 lines</done>
</task>

<task type="auto">
  <name>Task 5: Update src/config/loader.rs imports if needed</name>
  <files>src/config/loader.rs</files>
  <action>
Check if loader.rs has any duplicate functions that now exist in parser.rs.

If loader.rs contains load_config or find_and_load:
- Remove those functions from loader.rs
- Update any remaining code to import from parser module
- Or delete loader.rs entirely if all its content moved to parser.rs

If loader.rs is now empty or redundant, delete it and remove `pub mod loader;` from mod.rs.
  </action>
  <verify>
cat src/config/loader.rs | wc -l
# Should be 0 (deleted) or have unique content
cargo check --lib 2>&1 | grep -c "error"
# Should be 0
  </verify>
  <done>loader.rs either deleted or contains only unique utilities</done>
</task>

<task type="auto">
  <name>Task 6: Verify backward compatibility of imports</name>
  <files>src/lib.rs, src/main.rs, src/cli/*.rs</files>
  <action>
Verify that all existing imports still work:

```bash
# These patterns should still work:
use mcp_cli_rs::config::Config;
use mcp_cli_rs::config::ServerConfig;
use mcp_cli_rs::config::load_config;
```

Check that no code needs to be updated - all existing use statements should continue working through re-exports.

Run cargo check on entire project.
  </action>
  <verify>
cargo check --all-targets 2>&1 | tail -20
# Should show only warnings, no errors
cargo test --no-run 2>&1 | tail -10
# Should compile successfully
  </verify>
  <done>All existing imports work through re-exports, project compiles</done>
</task>

</tasks>

<verification>
After all tasks:
- [ ] src/config/types.rs exists with type definitions (150-250 lines)
- [ ] src/config/parser.rs exists with parsing functions (150-300 lines)
- [ ] src/config/validator.rs exists (30-200 lines)
- [ ] src/config/mod.rs is minimal re-export file (<100 lines)
- [ ] No duplicate functions between loader.rs and parser.rs
- [ ] cargo check passes with no errors
- [ ] cargo test --no-run compiles successfully
</verification>

<success_criteria>
- Config module split into types.rs, parser.rs, validator.rs
- All files under 300 lines (well under 600 limit)
- Backward compatible re-exports in mod.rs
- All code compiles without errors
- Existing import paths continue to work
</success_criteria>

<output>
After completion, create `.planning/phases/13-code-organization/13-01-SUMMARY.md` documenting:
- Files created/modified
- Line count changes
- Any issues encountered
</output>
