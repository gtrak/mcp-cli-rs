---
phase: 17-tool-call-integration-tests
plan: 04
type: execute
wave: 1
depends_on: [17-03]
files_modified:
  - tests/fixtures/mock_http_server.rs
  - tests/tool_call_http_tests.rs
  - tests/fixtures/mod.rs
autonomous: true
gap_closure: true
must_haves:
  truths:
    - "HTTP transport tool call tests pass consistently without flaky failures"
    - "All 13 HTTP tests pass when run in parallel"
    - "MockHttpServer accepts configuration via parameters instead of environment variables"
  artifacts:
    - path: "tests/fixtures/mock_http_server.rs"
      provides: "Refactored MockHttpServer with parameterized configuration"
      changes: "start() method accepts config struct, removes env var dependency"
    - path: "tests/tool_call_http_tests.rs"
      provides: "Updated tests using new parameterized API"
      changes: "All tests pass config directly to MockHttpServer::start()"
  key_links:
    - from: "tests/tool_call_http_tests.rs"
      to: "MockHttpServer::start()"
      via: "parameterized config struct"
      pattern: "MockHttpServer::start(config)"
---

<objective>
Fix HTTP test flakiness caused by environment variable race conditions in parallel test execution.

**Gap being closed:** HTTP transport tests fail intermittently (11/13 passing) due to MockHttpServer reading MOCK_TOOLS and MOCK_RESPONSES from environment variables at startup. When tests run in parallel, env var state conflicts between tests.

**Purpose:** Ensure all HTTP integration tests pass consistently regardless of test execution order or parallelism.
**Output:** Refactored MockHttpServer that accepts configuration via parameters, updated test file using new API.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/17-tool-call-integration-tests/17-VERIFICATION.md
@.planning/phases/17-tool-call-integration-tests/17-03-SUMMARY.md

## Gap Analysis

**Root Cause:** MockHttpServer reads MOCK_TOOLS and MOCK_RESPONSES environment variables during initialization. When tests run in parallel:
1. Test A sets MOCK_TOOLS=config_A
2. Test B sets MOCK_TOOLS=config_B  
3. Test A's server starts and reads config_B (wrong config)
4. Test A fails

**Current Implementation:**
- `MockHttpServer::start()` takes port parameter only
- Configuration loaded from `std::env::var("MOCK_TOOLS")` and `MOCK_RESPONSES`
- Tests call `unsafe { std::env::set_var(...) }` before starting server

**Required Changes:**
- Add configuration struct to pass tools/responses directly to MockHttpServer
- Remove environment variable dependency from server initialization
- Update all HTTP tests to use new API
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor MockHttpServer to accept parameterized configuration</name>
  <files>tests/fixtures/mock_http_server.rs</files>
  <action>
Refactor MockHttpServer to eliminate environment variable dependency:

1. Create a new `MockServerConfig` struct (or use existing one from fixtures/mod.rs) that holds:
   - `tools: Vec<ToolDefinition>` - tool definitions
   - `responses: HashMap<String, serde_json::Value>` - tool name → response mapping
   - `errors: HashMap<String, String>` - tool name → error message mapping

2. Modify `MockHttpServer::start()` signature from:
   ```rust
   pub async fn start(port: u16) -> Result<Self, Box<dyn std::error::Error>>
   ```
   to:
   ```rust
   pub async fn start(port: u16, config: MockServerConfig) -> Result<Self, Box<dyn std::error::Error>>
   ```

3. Update server initialization to:
   - Accept config as parameter instead of reading from environment
   - Store config in MockHttpServer instance
   - Update request handlers to use stored config instead of env vars

4. Remove or deprecate the `load_mock_config()` function that reads from environment

5. Ensure the refactor maintains backward compatibility with existing tests (or update them in Task 2)

**What to avoid:**
- Don't keep env var reading as fallback - remove it entirely to prevent confusion
- Don't change the HTTP protocol handling - only configuration loading changes
- Don't modify the stdio mock server - it's not affected by this issue (spawns fresh process per test)

**Why:** Process-level env vars are global state that causes race conditions in parallel tests. Parameterized configuration provides test-level isolation.
  </action>
  <verify>
    cargo check --tests
    cargo test --test tool_call_http_tests test_http_basic_tool_call -- --test-threads=1
  </verify>
  <done>
    - MockHttpServer::start() accepts config parameter
    - Server compiles without env var reading code
    - At least one test passes with new API
  </done>
</task>

<task type="auto">
  <name>Task 2: Update HTTP tests to use parameterized configuration</name>
  <files>tests/tool_call_http_tests.rs, tests/fixtures/mod.rs</files>
  <action>
Update all HTTP integration tests to use the new parameterized MockHttpServer API:

1. In `tests/fixtures/mod.rs`:
   - Export MockServerConfig if not already exported
   - Add helper function `create_test_config(tools, responses, errors) -> MockServerConfig`
   - Remove or mark as deprecated the env var setting helpers (keep for stdio tests which still need them)

2. In `tests/tool_call_http_tests.rs`, update each test:
   - Replace: `unsafe { std::env::set_var("MOCK_TOOLS", ...) }` followed by `MockHttpServer::start(port).await`
   - With: Create config struct, then `MockHttpServer::start(port, config).await`
   
   Example transformation:
   ```rust
   // Before
   unsafe {
       std::env::set_var("MOCK_TOOLS", json!(tools).to_string());
       std::env::set_var("MOCK_RESPONSES", json!(responses).to_string());
   }
   let server = MockHttpServer::start(0).await.unwrap();
   
   // After
   let config = MockServerConfig {
       tools,
       responses,
       errors: HashMap::new(),
   };
   let server = MockHttpServer::start(0, config).await.unwrap();
   ```

3. Update all 7 HTTP tests:
   - test_http_basic_tool_call
   - test_http_tool_call_with_args
   - test_http_tools_list
   - test_http_initialize_handshake
   - test_http_transport_error_handling
   - test_http_headers_passthrough
   - test_http_complex_nested_arguments

4. Remove the `unsafe { std::env::remove_var(...) }` cleanup calls at end of tests (no longer needed)

**What to avoid:**
- Don't change test logic or assertions - only configuration setup changes
- Don't remove env var helpers from fixtures/mod.rs entirely - stdio tests still use them
- Don't add `#[serial]` attribute - the point is to fix the root cause, not work around it

**Why:** Direct parameter passing eliminates shared mutable state between tests, allowing true parallel execution without race conditions.
  </action>
  <verify>
    cargo test --test tool_call_http_tests
    cargo test --test tool_call_http_tests -- --test-threads=8
  </verify>
  <done>
    - All 7 HTTP tests compile and pass
    - Tests pass consistently when run in parallel (--test-threads=8)
    - No unsafe env var operations in HTTP test file
    - All 13 tests (7 HTTP + 6 fixtures) pass
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify full test suite passes with parallel execution</name>
  <files>tests/tool_call_http_tests.rs</files>
  <action>
Run comprehensive verification to ensure the fix resolves the flakiness:

1. Run HTTP tests multiple times to verify consistency:
   ```bash
   for i in {1..5}; do
     cargo test --test tool_call_http_tests -- --test-threads=8
   done
   ```

2. Run full tool call test suite:
   ```bash
   cargo test --test tool_call_stdio_tests
   cargo test --test tool_call_error_tests
   cargo test --test tool_call_http_tests
   ```

3. Verify no regressions in stdio tests (they still use env vars via subprocess):
   ```bash
   cargo test --test tool_call_stdio_tests -- --test-threads=8
   ```

4. Document the fix in code comments explaining why parameterized config is used

**What to avoid:**
- Don't just run tests once - run multiple times to verify no flakiness
- Don't ignore any test failures - even "unrelated" ones might be caused by the changes
- Don't skip verifying stdio tests still work (they use different isolation model)

**Why:** The gap was intermittent failures; verification must prove the fix is robust across multiple runs.
  </action>
  <verify>
    cargo test --test tool_call_http_tests -- --test-threads=8
    echo "Exit code: $?"
  </verify>
  <done>
    - All 13 HTTP tests pass consistently (run 5 times, 100% pass rate)
    - All 4 stdio tests pass
    - All 7 error tests pass
    - Total: 18 tool call tests pass (11 + 4 + 7 + 6 fixtures = actual count may vary, verify with cargo test output)
  </done>
</task>

</tasks>

<verification>
After completing all tasks, verify:

1. **Consistency Check** (run 5 times):
   ```bash
   for i in {1..5}; do
     cargo test --test tool_call_http_tests -- --test-threads=8 || echo "FAILED on run $i"
   done
   ```
   Expected: All 5 runs pass

2. **Regression Check**:
   ```bash
   cargo test --test tool_call_stdio_tests
   cargo test --test tool_call_error_tests
   ```
   Expected: All tests pass (4 + 7 = 11 tests)

3. **Code Review**:
   - No `std::env::set_var` calls in tool_call_http_tests.rs
   - MockHttpServer::start() takes config parameter
   - All tests use new parameterized API

4. **Line Count Verification**:
   - tests/tool_call_http_tests.rs still >100 lines (should be ~500 still)
   - tests/fixtures/mock_http_server.rs changes are additive (new parameter, not massive rewrite)
</verification>

<success_criteria>
The gap is closed when:

1. **Observable:** `cargo test --test tool_call_http_tests -- --test-threads=8` passes 5 consecutive times
2. **Observable:** All 13 HTTP tests pass (7 transport + 6 fixture tests)
3. **Observable:** No test failures with "expected 3 tools but got 1" or "Tool not found" errors
4. **Artifact:** MockHttpServer::start() signature changed to accept config parameter
5. **Artifact:** tests/tool_call_http_tests.rs contains no unsafe env var operations
6. **Quality:** Code compiles with zero warnings (`cargo check --tests`)

**Gap closure confirmation:**
- [ ] HTTP transport tool call test passes (full roundtrip) - VERIFIED
- [ ] Test 11/13 → 13/13 passing (100% pass rate)
- [ ] Flaky tests (test_http_complex_nested_arguments, test_http_tools_list) now pass consistently
</success_criteria>

<output>
After completion, create `.planning/phases/17-tool-call-integration-tests/17-04-SUMMARY.md`

Include in SUMMARY.md:
- Root cause of flakiness (env var race conditions)
- Solution implemented (parameterized configuration)
- Test pass rate before/after (11/13 flaky → 13/13 consistent)
- Verification results from 5 consecutive parallel test runs
</output>
