---
phase: 04-tool-filtering
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/windows_process_tests.rs
  - tests/windows_process_spawn_tests.rs
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Windows process tests compile without errors"
    - "Child processes spawn and terminate cleanly when StdioTransport is dropped"
    - "All Windows process cleanup scenarios are tested"
  artifacts:
    - path: "tests/windows_process_tests.rs"
      provides: "Windows process lifecycle and cleanup unit tests"
      min_lines: 250
    - path: "tests/windows_process_spawn_tests.rs"
      provides: "Windows process integration and concurrent test scenarios"
      min_lines: 400
  key_links:
    - from: "tests/windows_process_tests.rs"
      to: "mcp_cli_rs::client::stdio::StdioTransport"
      via: "use import"
      pattern: "use mcp_cli_rs::client::stdio::StdioTransport"
    - from: "tests/windows_process_tests.rs"
      to: "tokio::io::AsyncBufReadExt"
      via: "use import"
      pattern: "use tokio::io::AsyncBufReadExt"
---

<objective>
Fix Windows process test compilation errors to enable XP-01 validation (no zombie processes)

Purpose: Windows process tests (04-02) were committed as complete but never compiled. Multiple compilation errors prevent verification that tokio::process::Command with kill_on_drop(true) prevents zombie processes on Windows. This plan fixes all compilation errors, making tests executable on Windows for XP-01 validation.

Output: Two fully compiling Windows test files that can run with `cargo test windows_process -- --ignored`
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-tool-filtering/04-VERIFICATION.md
@.planning/phases/04-tool-filtering/04-02-SUMMARY.md

# Existing work context from 04-02-SUMMARY.md:
- tests/windows_process_tests.rs: 279 lines with Windows process validation tests (marked #[ignore])
- tests/windows_process_spawn_tests.rs: 437 lines with integration tests (marked #[ignore])
- Tests validate XP-01: tokio::process::Command with kill_on_drop(true) prevents zombies
- src/client/stdio.rs already implements kill_on_drop(true) on line 83
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix import and type errors in windows_process_tests.rs</name>
  <files>tests/windows_process_tests.rs</files>
  <action>
    Fix the following compilation errors in tests/windows_process_tests.rs:

    1. Line 11: Change `use super::mcp_cli_rs::client::stdio::StdioTransport;` to `use mcp_cli_rs::client::stdio::StdioTransport;`
       - Tests at the crate root level should use direct crate import, not `super::`

    2. Line 14: Add trait import `use tokio::io::AsyncBufReadExt;` after the tokio::time::timeout import
       - This trait is required for read_line() and read_to_string() methods on BufReader

    3. Line 17: Change function signature from `fn verify_process_terminated(...) -> Result<bool>` to `fn verify_process_terminated(...) -> Result<bool, Box<dyn std::error::Error>>`
       - Result requires 2 generic arguments (T, E), not just T

    4. Line 29: Remove the `.read_to_end(&mut buffer)` call on stdout handle
       - ChildStdout does not have read_to_end() directly
       - Instead use: `use tokio::io::AsyncReadExt;` and wrap stdout in BufReader as done in other tests

    5. Type annotations for read_line calls (lines 93, 146, 230, 269):
       - The trait import from step 2 should fix these
       - Each line uses `reader.read_line(&mut line)` which requires AsyncBufReadExt

    6. Line 107: Remove unnecessary `mut` from `let mut child = tokio::process::Command::new("cmd.exe")`
       - Commander builder doesn't need to be mutable (warning only)

    IMPORTANT: Preserve all test logic and #[ignore] attributes. Only fix compilation errors.
  </action>
  <verify>cargo check --tests 2>&1 | grep "windows_process_tests.rs" | head -20</verify>
  <done>windows_process_tests.rs compiles without errors (no error[E] from cargo check)</done>
</task>

<task type="auto">
  <name>Task 2: Fix import and type errors in windows_process_spawn_tests.rs</name>
  <files>tests/windows_process_spawn_tests.rs</files>
  <action>
    Fix the following compilation errors in tests/windows_process_spawn_tests.rs:

    1. Line 9: Change `use super::mcp_cli_rs::client::stdio::StdioTransport;` to `use mcp_cli_rs::client::stdio::StdioTransport;`
       - Tests at the crate root level should use direct crate import, not `super::`

    2. Line 13: Add trait imports after the other imports:
       ```
       use tokio::io::AsyncBufReadExt;
       use tokio::io::AsyncWriteExt;
       ```
       - AsyncBufReadExt is required for read_line() method on BufReader
       - AsyncWriteExt is needed for the write operations in test_cleanup_after_send_failure

    3. Line 11: Remove unused import `use std::sync::Arc;` (warning only)
       - It's not used anywhere in the file

    4. Line 12: Remove unused import `use tokio::sync::Semaphore;` (warning only)
       - It's not used anywhere in the file

    5. Line 423: Replace `let mut writer = tokio::io::AsyncWriter::new(stdout);` with proper AsyncWrite implementation:
       ```
       let mut writer = stdout;
       ```
       - AsyncWriter does not exist in tokio::io
       - Use the stdout handle directly with AsyncWriteExt trait (already imported in step 2)

    6. Line 142: Fix Duration type mismatch by casting to u64:
       Change `let delay = Duration::from_millis((i % 3 + 1) * 100);`
       To: `let delay = Duration::from_millis(((i % 3 + 1) * 100) as u64);`
       - Duration::from_millis expects u64, but arithmetic produces usize

    7. Line 292: Remove duplicate import `use std::sync::Arc;` (already imported at line 11)

    IMPORTANT: Preserve all test logic and #[ignore] attributes. Only fix compilation errors.
  </action>
  <verify>cargo check --tests 2>&1 | grep "windows_process_spawn_tests.rs" | head -20</verify>
  <done>windows_process_spawn_tests.rs compiles without errors (no error[E] from cargo check)</done>
</task>

<task type="auto">
  <name>Task 3: Verify both test files compile successfully</name>
  <files>tests/windows_process_tests.rs, tests/windows_process_spawn_tests.rs</files>
  <action>
    Verify that both Windows test files now compile without errors by running cargo check.

    Run: `cargo check --tests`

    Verify no compilation errors remain for either test file. The only warnings should be unused imports or variables (warnings are acceptable).

    If any errors remain, fix them in the appropriate test file.
  </action>
  <verify>cargo check --tests 2>&1 | grep -E "error\[E" | grep -E "(windows_process_tests|windows_process_spawn_tests)"</verify>
  <done>Both Windows test files compile cleanly with no errors. cargo check --tests succeeds.</done>
</task>

</tasks>

<verification>
- [ ] tests/windows_process_tests.rs compiles without errors
- [ ] tests/windows_process_spawn_tests.rs compiles without errors
- [ ] All trait imports present (AsyncBufReadExt, AsyncReadExt, AsyncWriteExt)
- [ ] Import paths corrected (super::mcp_cli_rs â†’ mcp_cli_rs)
- [ ] Result types have error parameters (Result<T, E>)
- [ ] AsyncWriter replaced with proper type
- [ ] Type annotation issues resolved
- [ ] Tests preserve all original logic and #[ignore] attributes
- [ ] XP-01 validation tests ready for execution on Windows
</verification>

<success_criteria>
Both Windows test files compile successfully with `cargo check --tests`, enabling XP-01 validation (no zombie processes) when tests are run on Windows with `cargo test windows_process -- --ignored`.
</success_criteria>

<output>
After completion, create `.planning/phases/04-tool-filtering/04-04-SUMMARY.md`
</output>
