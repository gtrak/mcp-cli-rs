---
phase: 25-cross-platform-test-validation
plan: 06
type: execute
wave: 1
depends_on:
  - 25-05
files_modified:
  - tests/helpers.rs
  - tests/unix/tests.rs
  - tests/common/mod.rs
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Stale socket files are cleaned up before test starts"
    - "Socket files are removed after test completes"
    - "create_ipc_server handles existing socket files gracefully"
    - "No 'Failed to remove stale socket file' errors"
  artifacts:
    - path: "tests/helpers.rs"
      provides: "Socket cleanup helper functions"
      pattern: "cleanup_socket|remove_socket"
    - path: "src/ipc/unix.rs"
      provides: "Stale socket handling"
      pattern: "remove_file|bind"
    - path: "tests/unix/tests.rs"
      provides: "Test cleanup in #[test] blocks"
      pattern: "drop.*socket_path|cleanup_socket"

user_setup: []
---

<objective>
Add robust socket cleanup to prevent "Failed to remove stale socket file" errors.

**Purpose:** Tests fail when previous test runs leave behind stale socket files. The `create_ipc_server()` function tries to remove stale files but this can fail if the file is in use or permissions issues.

**Gap being closed:**
- REVerification.md: "Stale Socket Files" - Tests fail to clean up socket files between runs
- REVerification.md: "test_unix_socket_cleanup_on_removal" failing

**Root cause:** 
1. Socket files not cleaned up after test panics or fails
2. Multiple tests may leave stale files in /tmp
3. `create_ipc_server()` bind fails if socket file exists and can't be removed
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/25-cross-platform-test-validation/25-REVERIFICATION.md
@.planning/phases/25-cross-platform-test-validation/25-05-SUMMARY.md
@tests/helpers.rs
@tests/unix/tests.rs
@src/ipc/unix.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add socket cleanup helper to tests/helpers.rs</name>
  <files>tests/helpers.rs</files>
  <action>
    Add socket cleanup helper functions to tests/helpers.rs.

    Add these functions after get_test_socket_path_with_suffix():

    ```rust
    /// Clean up socket file if it exists
    /// 
    /// Should be called at the start of each test to ensure clean state,
    /// and in cleanup to ensure no stale files remain.
    pub fn cleanup_socket_file(socket_path: &std::path::Path) {
        if socket_path.exists() {
            let _ = std::fs::remove_file(socket_path);
        }
    }

    /// Clean up all MCP test socket files in temp directory
    /// 
    /// Use sparingly - only when test isolation is broken.
    pub fn cleanup_all_test_sockets() {
        let temp_dir = std::env::temp_dir();
        if let Ok(entries) = std::fs::read_dir(&temp_dir) {
            for entry in entries.flatten() {
                if let Ok(name) = entry.file_name().into_string() {
                    if name.starts_with("mcp-test-") && name.ends_with(".sock") {
                        let _ = std::fs::remove_file(entry.path());
                    }
                }
            }
        }
    }
    ```

    Then update `get_test_socket_path()` and `get_test_socket_path_with_suffix()` to call cleanup_socket_file at the start:

    ```rust
    pub fn get_test_socket_path() -> PathBuf {
        let mut path = std::env::temp_dir();
        path.push(format!("mcp-test-{}-{}.sock", 
            std::process::id(),
            SOCKET_COUNTER.fetch_add(1, Ordering::SeqCst)
        ));
        cleanup_socket_file(&path);  // Clean up any stale file
        path
    }
    ```
  </action>
  <verify>
    - `cargo build --tests` compiles
    - `grep -n "cleanup_socket_file" tests/helpers.rs` finds the function
    - `grep -n "cleanup_socket_file" tests/helpers.rs | wc -l` shows at least 3 usages
  </verify>
  <done>
    cleanup_socket_file() helper exists and is called in get_test_socket_path().
  </done>
</task>

<task type="auto">
  <name>Task 2: Ensure tests clean up sockets on completion</name>
  <files>tests/unix/tests.rs</files>
  <action>
    Add proper cleanup to all Unix socket tests.

    Pattern for each test:
    ```rust
    #[tokio::test]
    async fn test_unix_socket_xxx() {
        let socket_path = crate::helpers::get_test_socket_path();
        
        // Test code here...
        
        // Cleanup at end
        crate::helpers::cleanup_socket_file(&socket_path);
    }
    ```

    Review each test in tests/unix/tests.rs and add cleanup_socket_file() call at the end:
    - test_unix_socket_creation
    - test_unix_socket_client_server_roundtrip
    - test_unix_socket_multiple_concurrent_connections
    - test_unix_socket_large_message_transfer
    - test_unix_socket_stale_error_handling
    - test_unix_socket_cleanup_on_removal (may be testing cleanup behavior specifically)

    For tests that spawn async tasks, ensure cleanup happens after await:
    ```rust
    let result = test_operation().await;
    crate::helpers::cleanup_socket_file(&socket_path);
    result
    ```

    Note: Some tests may already have cleanup in the form of `let _ = std::fs::remove_file()`. Replace with the helper function.
  </action>
  <verify>
    - `grep -n "cleanup_socket_file" tests/unix/tests.rs` shows usage in each test function
    - `cargo build --tests` compiles
  </verify>
  <done>
    All Unix socket tests call cleanup_socket_file() at the end.
  </done>
</task>

<task type="auto">
  <name>Task 3: Improve create_ipc_server stale socket handling</name>
  <files>src/ipc/unix.rs</files>
  <action>
    Review and improve stale socket file handling in src/ipc/unix.rs.

    The current implementation likely has something like:
    ```rust
    // Remove stale socket file if it exists
    if socket_path.exists() {
        std::fs::remove_file(socket_path)?;
    }
    ```

    Improve this to:
    1. Try to remove stale file
    2. If that fails, check if we can still bind (file might not be a socket)
    3. Provide better error messages

    ```rust
    // In src/ipc/unix.rs create_ipc_server function:
    
    // Remove stale socket file if it exists
    if socket_path.exists() {
        match std::fs::remove_file(socket_path) {
            Ok(_) => {}
            Err(e) => {
                // If we can't remove it, the bind might still succeed
                // (e.g., if it's not actually a socket)
                eprintln!("Warning: Could not remove stale socket file: {}", e);
            }
        }
    }
    ```

    The key is to NOT fail immediately if we can't remove the stale file - just warn and try to bind anyway.
  </action>
  <verify>
    - `cargo build` compiles
    - `grep -A5 "stale\|exists()" src/ipc/unix.rs` shows improved handling
    - No compile errors
  </verify>
  <done>
    create_ipc_server() handles stale socket files gracefully (warns but continues).
  </done>
</task>

<task type="auto">
  <name>Task 4: Run tests and verify cleanup works</name>
  <files></files>
  <action>
    Run tests multiple times to verify cleanup prevents stale file accumulation.

    ```bash
    # First run
    cargo test --test unix_tests 2>&1
    
    # Check for stale files
    ls -la /tmp/mcp-test-*.sock 2>/dev/null | wc -l
    
    # Second run
    cargo test --test unix_tests 2>&1
    
    # Check again - should be 0 or very few
    ls -la /tmp/mcp-test-*.sock 2>/dev/null | wc -l
    ```

    Also run with specific test:
    ```bash
    cargo test test_unix_socket_stale_error_handling -- --nocapture 2>&1
    ```

    Verify:
    - No "Failed to remove stale socket file" errors
    - Socket files are cleaned up after tests
    - Tests pass consistently
  </action>
  <verify>
    - All Unix socket tests pass
    - `ls /tmp/mcp-test-*.sock 2>/dev/null | wc -l` shows 0 or very few files after tests
    - No stale file errors in test output
  </verify>
  <done>
    Tests pass and no stale socket files accumulate.
  </done>
</task>

<task type="auto">
  <name>Task 5: Commit changes and create SUMMARY</name>
  <files>
    tests/helpers.rs
    tests/unix/tests.rs
    src/ipc/unix.rs
    .planning/phases/25-cross-platform-test-validation/25-06-SUMMARY.md
  </files>
  <action>
    Commit the changes:
    1. Stage modified files
    2. Commit: "fix(25-06): add robust socket cleanup between tests"
    
    Create SUMMARY.md documenting:
    - Socket cleanup improvements
    - Helper functions added
    - Test results after fix
  </action>
  <verify>
    - Git log shows commit with message pattern "fix(25-06):"
    - SUMMARY.md exists in phase directory
  </verify>
  <done>
    Changes committed and SUMMARY.md created.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. No "Failed to remove stale socket file" errors
2. /tmp has no accumulating mcp-test-*.sock files
3. All Unix socket tests pass
4. Tests can be run multiple times without socket conflicts
</verification>

<success_criteria>
- [ ] cleanup_socket_file() helper exists in tests/helpers.rs
- [ ] All tests call cleanup helper
- [ ] create_ipc_server handles stale files gracefully
- [ ] No stale socket file errors in test output
- [ ] /tmp doesn't accumulate socket files
- [ ] All Unix socket tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/25-cross-platform-test-validation/25-06-SUMMARY.md`
</output>
