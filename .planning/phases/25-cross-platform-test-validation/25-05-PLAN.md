---
phase: 25-cross-platform-test-validation
plan: 05
type: execute
wave: 1
depends_on:
  - 25-03
  - 25-04
files_modified:
  - tests/helpers.rs
  - tests/unix/tests.rs
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "get_test_socket_path() returns unique path per test invocation"
    - "Tests use thread-safe unique identifiers not just process_id"
    - "5 Unix socket tests no longer conflict with each other"
    - "Tests can run in parallel without socket conflicts"
  artifacts:
    - path: "tests/helpers.rs"
      provides: "Unique socket path generation"
      pattern: "thread_local|atomic|random"
    - path: "tests/unix/tests.rs"
      provides: "Updated test socket paths"
      min_lines: 200

user_setup: []
---

<objective>
Fix socket path conflicts in Unix tests by using unique identifiers per test.

**Purpose:** Tests currently use `std::process::id()` which is the same for all tests running in parallel, causing socket path conflicts. This results in "Address already in use" and "Connection refused" errors.

**Gap being closed:**
- REVerification.md: "Socket Conflicts" - Tests fail with "Address already in use"
- REVerification.md: "5 Unix socket tests still fail (different errors)"

**Root cause:** `get_test_socket_path()` returns the same path for all concurrent tests because it only uses `process_id()` which doesn't change across async test tasks.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/25-cross-platform-test-validation/25-REVERIFICATION.md
@.planning/phases/25-cross-platform-test-validation/25-03-SUMMARY.md
@tests/helpers.rs
@tests/unix/tests.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update get_test_socket_path to use unique identifiers</name>
  <files>tests/helpers.rs</files>
  <action>
    Modify `get_test_socket_path()` in tests/helpers.rs to generate truly unique socket paths.

    Current implementation:
    ```rust
    pub fn get_test_socket_path() -> PathBuf {
        let mut path = std::env::temp_dir();
        path.push(format!("mcp-test-{}.sock", std::process::id()));
        path
    }
    ```

    Problems:
    1. `std::process::id()` is the same for all tests in the same process
    2. Tests running in parallel get the same socket path
    3. Causes "Address already in use" errors

    Solution options (choose best):
    
    Option A - Thread-local counter (recommended):
    ```rust
    use std::sync::atomic::{AtomicU64, Ordering};
    
    static SOCKET_COUNTER: AtomicU64 = AtomicU64::new(0);
    
    pub fn get_test_socket_path() -> PathBuf {
        let counter = SOCKET_COUNTER.fetch_add(1, Ordering::SeqCst);
        let mut path = std::env::temp_dir();
        path.push(format!("mcp-test-{}-{}.sock", 
            std::process::id(),
            counter
        ));
        path
    }
    ```

    Option B - Timestamp + random:
    ```rust
    use std::time::{SystemTime, UNIX_EPOCH};
    
    pub fn get_test_socket_path() -> PathBuf {
        let timestamp = SystemTime::now()
            .duration_since(UNIX_EPOCH)
            .unwrap()
            .as_nanos();
        let random = std::process::id() ^ timestamp as u32;
        let mut path = std::env::temp_dir();
        path.push(format!("mcp-test-{}-{}.sock", timestamp, random));
        path
    }
    ```

    Also update `get_test_socket_path_with_suffix()` to use the same unique identifier approach.

    IMPORTANT: Ensure the implementation is thread-safe (AtomicU64) so parallel tests work correctly.
  </action>
  <verify>
    - `cargo build --tests` compiles successfully
    - Run `cargo test test_unix_socket_creation -- --test-threads=1` and verify it passes
    - Check the socket path in test output is unique
  </verify>
  <done>
    get_test_socket_path() uses unique identifiers (not just process_id), and tests compile and pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Unix tests to use unique socket paths</name>
  <files>tests/unix/tests.rs</files>
  <action>
    Review and update tests/unix/tests.rs to ensure proper socket path usage.

    The tests should already be using `get_test_socket_path()` which will now return unique paths. Verify:

    1. All test functions call `get_test_socket_path()` at the start
    2. Each test uses its own socket path (no sharing between tests)
    3. Socket cleanup happens at the end of each test

    If any tests are hardcoding socket paths or reusing the same path, update them to use the helper function.

    Key tests to verify:
    - test_unix_socket_creation
    - test_unix_socket_client_server_roundtrip  
    - test_unix_socket_multiple_concurrent_connections
    - test_unix_socket_large_message_transfer
    - test_unix_socket_stale_error_handling
    - test_unix_socket_cleanup_on_removal

    Note: The existing tests likely already use get_test_socket_path(), so this task may be a verification pass with no changes needed.
  </action>
  <verify>
    - `cargo test --test unix_tests -- --test-threads=1` passes all tests
    - Each test creates a unique socket file in /tmp (check with `ls -la /tmp/*.sock`)
  </verify>
  <done>
    All Unix socket tests pass when run individually, each using unique socket paths.
  </done>
</task>

<task type="auto">
  <name>Task 3: Run Unix tests in parallel and verify no conflicts</name>
  <files></files>
  <action>
    Run the Unix socket tests in parallel (the default) to verify socket conflicts are resolved.

    ```bash
    cargo test --test unix_tests 2>&1
    ```

    Expected: All tests should pass without "Address already in use" or "Connection refused" errors.

    If tests still fail:
    - Check if socket files are being cleaned up properly between tests
    - Look for any remaining hardcoded socket paths
    - Verify the atomic counter is incrementing correctly

    Run multiple times to ensure consistency:
    ```bash
    for i in {1..3}; do
      cargo test --test unix_tests 2>&1 | tail -20
    done
    ```
  </action>
  <verify>
    - `cargo test --test unix_tests` passes (all 6 tests)
    - No "Address already in use" errors in output
    - Run 3 consecutive times, all pass
  </verify>
  <done>
    All 6 Unix socket tests pass consistently when run in parallel.
  </done>
</task>

<task type="auto">
  <name>Task 4: Commit changes and create SUMMARY</name>
  <files>
    tests/helpers.rs
    .planning/phases/25-cross-platform-test-validation/25-05-SUMMARY.md
  </files>
  <action>
    Commit the changes:
    1. Stage tests/helpers.rs
    2. Commit: "fix(25-05): use unique socket paths to prevent test conflicts"
    
    Then create SUMMARY.md documenting:
    - What was fixed (socket path generation)
    - How it was fixed (AtomicU64 counter)
    - Test results after fix
  </action>
  <verify>
    - Git log shows commit with message pattern "fix(25-05):"
    - SUMMARY.md exists in phase directory
  </verify>
  <done>
    Changes committed and SUMMARY.md created with verification results.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. All 6 Unix socket tests pass when run in parallel
2. No "Address already in use" errors in test output
3. Socket files in /tmp are unique per test
4. Tests can be run multiple times consecutively without failures
</verification>

<success_criteria>
- [ ] get_test_socket_path() generates unique paths per test
- [ ] All 6 Unix socket tests pass
- [ ] Tests pass when run in parallel (cargo test --test unix_tests)
- [ ] Tests pass when run 3+ consecutive times
- [ ] No socket conflict errors in output
</success_criteria>

<output>
After completion, create `.planning/phases/25-cross-platform-test-validation/25-05-SUMMARY.md`
</output>
