---
phase: 05-unified-daemon
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - src/main.rs
  - src/bin/daemon.rs (deleted)
  - src/cli/mod.rs
  - src/cli/daemon.rs
autonomous: true

must_haves:
  truths:
    - "Single binary mcp.exe exists (no separate daemon.exe)"
    - "Cargo.toml has only one [[bin]] entry"
    - "Daemon code is accessible from main crate"
  artifacts:
    - path: "Cargo.toml"
      provides: "Single binary configuration"
      must_contain: "[[bin]] entry for mcp only"
    - path: "src/main.rs"
      provides: "CLI entry point with daemon subcommand capability"
    - path: "src/lib.rs"
      provides: "Library exports for daemon functionality"
  key_links:
    - from: "src/main.rs"
      to: "src/daemon/mod.rs"
      via: "use mcp_cli_rs::daemon"
---

<objective>
Remove the separate daemon binary and integrate daemon functionality into the main CLI binary.

Purpose: Simplify deployment by having only one binary (DAEMON-01, DAEMON-12)
Output: Single binary configuration with daemon code accessible as library
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md

The current architecture has two binaries:
1. `mcp` (main CLI) in src/main.rs
2. `mcp-daemon` (daemon) in src/bin/daemon.rs

We need to merge these into a single binary with the daemon accessible via `mcp daemon` subcommand.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Cargo.toml to remove daemon binary</name>
  <files>Cargo.toml</files>
  <action>
Remove the [[bin]] section for daemon from Cargo.toml. Keep only the default binary (src/main.rs).

Current Cargo.toml has no explicit [[bin]] sections (uses default), so we just need to ensure it stays that way.

Verify the package builds as a single binary:
- `cargo build` should produce only `mcp.exe` (or `mcp` on Unix)
- No `daemon.exe` or `mcp-daemon.exe` should be produced
  </action>
  <verify>
cargo build --release 2>&1 | head -20
ls -la target/release/*.exe 2>/dev/null || ls -la target/release/mcp* 2>/dev/null
  </verify>
  <done>
Only mcp.exe (or mcp) binary exists in target/release/, no daemon binary present
  </done>
</task>

<task type="auto">
  <name>Task 2: Delete src/bin/daemon.rs</name>
  <files>src/bin/daemon.rs</files>
  <action>
Delete the separate daemon binary file src/bin/daemon.rs entirely.

The daemon logic will be integrated into the main CLI as a subcommand in Plan 05-02.

Before deleting, note the key daemon startup code that will need to be preserved:
- Config loading via find_and_load()
- Socket path retrieval via get_socket_path()
- Tracing initialization
- Daemon execution via run_daemon()
  </action>
  <verify>
! test -f src/bin/daemon.rs && echo "daemon.rs deleted successfully"
  </verify>
  <done>
src/bin/daemon.rs no longer exists
  </done>
</task>

<task type="auto">
  <name>Task 3: Export daemon modules from lib.rs</name>
  <files>src/lib.rs</files>
  <action>
Ensure src/lib.rs exports the daemon module so main.rs can access it.

Check current lib.rs exports and add daemon module if not already present:
```rust
pub mod daemon;
```

This allows main.rs to use `mcp_cli_rs::daemon::run_daemon` for the daemon subcommand.
  </action>
  <verify>
grep -n "pub mod daemon" src/lib.rs || grep -n "mod daemon" src/lib.rs
  </verify>
  <done>
daemon module is exported from lib.rs (pub mod daemon or mod daemon present)
  </done>
</task>

</tasks>

<verification>
- [ ] `cargo build` produces only one binary (mcp/mcp.exe)
- [ ] No daemon binary exists in target/
- [ ] src/bin/daemon.rs is deleted
- [ ] src/lib.rs exports daemon module
- [ ] All existing tests still pass: `cargo test`
</verification>

<success_criteria>
Single binary distribution achieved:
- Only mcp.exe/mcp binary is built
- Daemon functionality accessible via library exports
- No separate daemon executable exists
</success_criteria>

<output>
After completion, create `.planning/phases/05-unified-daemon-architecture/05-01-SUMMARY.md`
</output>
