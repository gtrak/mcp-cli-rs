---
phase: 16-code-quality-sweep
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cli/models.rs
  - src/daemon/pool.rs
  - src/cli/formatters.rs
  - src/cli/call.rs
  - src/cli/info.rs
  - src/cli/search.rs
  - src/cli/commands.rs

must_haves:
  truths:
    - "No bare unwrap() calls remain in production code"
    - "All unwrap() replaced with proper error handling (ok_or_else, expect with context, or ?)"
    - "Mutex lock unwraps use expect with descriptive message"
  artifacts:
    - path: "src/daemon/pool.rs"
      provides: "Safe mutex lock handling"
      contains: "expect()"
    - path: "src/cli/*.rs"
      provides: "Proper error propagation"
      contains: "? or ok_or_else"
---

<objective>
Replace all unsafe unwrap() calls with proper error handling (QUAL-01, QUAL-04).

Purpose: Consistent error handling prevents panics and provides better error messages.
Output: Zero bare unwrap() in production code.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md (QUAL-01, QUAL-04)
@.planning/ROADMAP.md (Phase 16)
@.planning/STATE.md
@.planning/phases/16-code-quality-sweep/16-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Replace Mutex lock unwraps with expect</name>
  <files>src/daemon/pool.rs</files>
  <action>
Replace bare .unwrap() on mutex locks with .expect() with descriptive message:
- Line 56: `self.connections.lock().unwrap()` â†’ `self.connections.lock().expect("Failed to acquire connection pool lock")`
- Line 88: Same pattern
- Line 286: Same pattern
- Line 291: Same pattern
- Line 316: Same pattern

Mutex locks should use expect() because if the lock poisons, we want a clear error message.
  </action>
  <verify>grep -n "\.unwrap()" src/daemon/pool.rs should return nothing</verify>
  <done>All mutex lock unwraps replaced with expect</done>
</task>

<task type="auto">
  <name>Replace serde_json unwraps</name>
  <files>src/cli/models.rs, src/config_fingerprint.rs, src/daemon/mod.rs, src/parallel.rs, src/output.rs, src/daemon/protocol.rs</files>
  <action>
Replace unwrap() on serde_json operations with ? operator:
1. src/cli/models.rs (lines 211, 228, 252, 269, 288): These are in serialize methods - use ok_or_else or handle differently
2. src/config_fingerprint.rs line 30: Add ? return or handle error
3. src/daemon/mod.rs line 260: Add ? return or handle error
4. src/parallel.rs line 156: Use expect() for semaphore acquire (cannot recover)
5. src/output.rs lines 262, 264, 266, 278: Use ok_or_else or handle
6. src/daemon/protocol.rs lines 259, 266: Add ? return

For serialization that returns String, use unwrap_or_else to return empty string on failure, or propagate the error.
  </action>
  <verify>grep -c "\.unwrap()" in these files should be reduced</verify>
  <done>Serialization unwraps handled properly</done>
</task>

<task type="auto">
  <name>Replace remaining unwraps in CLI code</name>
  <files>src/cli/formatters.rs, src/cli/call.rs, src/cli/info.rs, src/cli/search.rs, src/cli/commands.rs, src/config/loader.rs, src/cli/daemon.rs, src/client/http.rs, src/cli/filter.rs</files>
  <action>
Replace remaining unwrap() calls:
1. src/cli/formatters.rs line 496: Use if let or ok_or_else
2. src/cli/call.rs lines 204, 206: Use if let with as_ref().map_or
3. src/cli/info.rs lines 249, 258: Use ? or handle error
4. src/cli/search.rs line 117: Pattern::new can fail - use match or ok_or
5. src/cli/commands.rs lines 24, 33: Use ? operator
6. src/config/loader.rs line 165: Use ? or unwrap_or_default
7. src/cli/daemon.rs line 173: Use ok() or expect for critical path
8. src/client/http.rs: These parse headers - use expect as they should be valid
9. src/cli/filter.rs line 182: Use ok_or_else

Use context-appropriate error handling:
- For things that "cannot fail if code is correct" (like header parsing): use expect with message
- For things that can fail: use ? or ok_or_else
  </action>
  <verify>grep -c "\.unwrap()" src/cli/*.rs src/client/*.rs src/config/*.rs src/daemon/*.rs should be minimal</verify>
  <done>All CLI code unwraps handled</done>
</task>

</tasks>

<verification>
- Run `grep -r "\.unwrap()" src/` - should find zero matches or only in test code
- Run `cargo clippy --lib` - should have no unwrap warnings
</verification>

<success_criteria>
- [ ] No bare .unwrap() calls in production code
- [ ] All unwrap() replaced with expect() with context OR ? operator
- [ ] clippy --lib has no unwrap warnings
</success_criteria>

<output>
After completion, create `.planning/phases/16-code-quality-sweep/16-01-SUMMARY.md`
</output>
