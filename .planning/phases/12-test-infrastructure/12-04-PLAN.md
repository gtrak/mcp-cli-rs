---
phase: 12-test-infrastructure
plan: 04
type: execute
wave: 4
depends_on: [12-01]
files_modified: [tests/lifecycle_tests.rs, tests/windows_process_spawn_tests.rs]
autonomous: true

must_haves:
  truths:
    - "lifecycle_tests.rs uses TestEnvironment for temp directory management"
    - "windows_process_spawn_tests.rs uses helpers where applicable"
    - "Test duplication reduced in both files"
    - "All tests pass with identical behavior"
  artifacts:
    - path: "tests/lifecycle_tests.rs"
      provides: "Daemon lifecycle tests using helpers"
      contains: "use crate::helpers::"
    - path: "tests/windows_process_spawn_tests.rs"
      provides: "Windows process spawn tests using helpers"
      contains: "use crate::helpers::"
  key_links:
    - from: "tests/lifecycle_tests.rs"
      to: "tests/helpers.rs"
      via: "use crate::helpers::TestEnvironment"
      pattern: "let env = TestEnvironment::new()"
    - from: "tests/windows_process_spawn_tests.rs"
      to: "tests/helpers.rs"
      via: "helpers for config and paths"
      pattern: "use crate::helpers::"
</context>

---

<objective>
Refactor lifecycle_tests.rs and windows_process_spawn_tests.rs to use test helpers

Purpose: Eliminate duplication in temp directory setup and common patterns, reducing ~30-50 lines total
Output: Both files updated to use helpers where applicable
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
@.planning/phases/12-test-infrastructure/12-01-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Reference: Original files
@tests/lifecycle_tests.rs                   (455 lines)
@tests/windows_process_spawn_tests.rs       (452 lines)

# Helpers available from plan 12-01
@tests/helpers.rs
</context>

<tasks>

<task type="auto">
  <name>Analyze lifecycle_tests.rs for TempDir usage and helper opportunities</name>
  <files>tests/lifecycle_tests.rs</files>
  <action>
Analyze tests/lifecycle_tests.rs systematically:

1. Read the entire file to identify:
   - TempDir usage patterns
   - Config construction patterns
   - Socket/pipe path generation
   - Any other common patterns

2. From the file structure (lines 1-100 read already):
   - Tests focus on DaemonLifecycle functionality
   - Uses Arc<Mutex<DaemonLifecycle>> pattern
   - May have temp directory usage not visible in first 100 lines

3. Read full file:
```bash
cat tests/lifecycle_tests.rs
```

4. Document findings:
   - Count of TempDir::new() calls
   - Count of Config::default() calls
   - Any socket/pipe path generation
   - Total line reduction potential

5. Add mod declaration if helpers will be used:
```rust
#[cfg(test)]
mod helpers;
```

Expected: Identify 15-30 lines of duplication to eliminate
</action>
  <verify>grep -c "TempDir" tests/lifecycle_tests.rs && grep -c "Config::" tests/lifecycle_tests.rs</verify>
  <done>Analyzed lifecycle_tests.rs, identified duplication patterns</done>
</task>

<task type="auto">
  <name>Refactor lifecycle_tests.rs to use helpers</name>
  <files>tests/lifecycle_tests.rs</files>
  <action>
Update tests/lifecycle_tests.rs based on analysis:

1. If TempDir usage found:
   - Add mod declaration
   - Replace TempDir::new() with TestEnvironment::new()
   - Replace .path() calls with env.path()
   - Remove explicit temp_dir cleanup

2. If Config::default() found:
   - Replace with create_test_config()

3. If any socket/pipe paths found:
   - Replace with get_test_socket_path()

4. For other patterns, identify if they match helpers or if new helper functions should be added

Note: lifecycle_tests.rs may have less direct duplication than other files if it focuses purely on DaemonLifecycle logic without temp files. In that case, just add mod declaration and document that no significant duplication was found.

Expected lines removed: 10-20 lines
</action>
  <verify>cargo test lifecycle --lib 2>&1 | tail -20</verify>
  <done>lifecycle_tests.rs refactored to use helpers where applicable</done>
</task>

<task type="auto">
  <name>Analyze windows_process_spawn_tests.rs for helper opportunities</name>
  <files>tests/windows_process_spawn_tests.rs</files>
  <action>
Analyze tests/windows_process_spawn_tests.rs:

1. Read the entire file to identify:
   - TempDir usage
   - Config construction
   - Socket/pipe paths
   - Other patterns from helpers.rs

2. Read full file:
```bash
cat tests/windows_process_spawn_tests.rs
```

3. Document findings:
   - Count patterns that match helpers
   - Identify unique patterns specific to Windows process testing
   - Note integration with tokio::process::Command

4. Add mod declaration if helpers will be used:
```rust
#[cfg(test)]
mod helpers;
```

Expected: Identify 10-20 lines of duplication to eliminate
</action>
  <verify>grep -c "TempDir\|Config::\|std::env::temp_dir" tests/windows_process_spawn_tests.rs</verify>
  <done>Analyzed windows_process_spawn_tests.rs, identified opportunities</done>
</task>

<task type="auto">
  <name>Refactor windows_process_spawn_tests.rs to use helpers</name>
  <files>tests/windows_process_spawn_tests.rs</files>
  <action>
Update tests/windows_process_spawn_tests.rs based on analysis:

1. If Config usage found:
   - Replace with create_test_config()

2. If any temp directory usage found:
   - Replace with TestEnvironment

3. If any socket/pipe paths found:
   - Replace with get_test_socket_path()

Note: This file focuses on process spawning with tokio::process::Command, which is Windows-specific behavior testing. It may have less duplication if it doesn't use common test patterns.

Focus on:
- Any config construction
- Any temp directory setup
- Any path generation

Expected lines removed: 5-10 lines (may be less than other files)
</action>
  <verify>cargo test windows_process_spawn --lib 2>&1 | tail -20</verify>
  <done>windows_process_spawn_tests.rs refactored to use helpers where applicable</done>
</task>

<task type="auto">
  <name>Verify test behavior and count line reduction</name>
  <files>tests/lifecycle_tests.rs, tests/windows_process_spawn_tests.rs</files>
  <action>
Run tests and verify behavior unchanged:

```bash
# Run lifecycle tests
cargo test lifecycle --lib

# Run Windows process spawn tests
cargo test windows_process_spawn --lib -- --ignored

# Check line counts
wc -l tests/lifecycle_tests.rs tests/windows_process_spawn_tests.rs
```

Document line reduction:
- lifecycle_tests.rs: original 455 lines -> new XX lines (reduced by XX)
- windows_process_spawn_tests.rs: original 452 lines -> new XX lines (reduced by XX)

Verify all tests pass with identical behavior.
</action>
  <verify>cargo test lifecycle --lib 2>&1 | grep "test result" && wc -l tests/lifecycle_tests.rs tests/windows_process_spawn_tests.rs</verify>
  <done>All tests pass, line reduction documented</done>
</task>

</tasks>

<verification>
After completion:
```bash
# Compare line counts
echo "lifecycle_tests.rs: 455 -> $(wc -l < tests/lifecycle_tests.rs)"
echo "windows_process_spawn_tests.rs: 452 -> $(wc -l < tests/windows_process_spawn_tests.rs)"

# Verify tests pass
cargo test lifecycle windows_process_spawn --lib 2>&1 | grep "test result"
```
</verification>

<success_criteria>
- lifecycle_tests.rs reduced by ~10-20 lines through helper use
- windows_process_spawn_tests.rs reduced by ~5-10 lines through helper use
- Both files import helpers module
- Any applicable patterns use helper functions
- All tests pass with identical behavior
- No new warnings or errors
- Line reduction documented in summary
</success_criteria>

<output>
After completion, create `.planning/phases/12-test-infrastructure/12-04-SUMMARY.md`
</output>
