---
phase: 12-test-infrastructure
plan: 02
type: execute
wave: 2
depends_on: [12-01]
files_modified: [tests/ipc_tests.rs, tests/orphan_cleanup_tests.rs]
autonomous: true

must_haves:
  truths:
    - "ipc_tests.rs uses helpers from tests/helpers.rs instead of inline setup"
    - "orphan_cleanup_tests.rs uses TestEnvironment instead of TempDir::new()"
    - "Socket/pipe path generation uses get_test_socket_path() helper"
    - "All tests pass with identical behavior before and after refactoring"
  artifacts:
    - path: "tests/ipc_tests.rs"
      provides: "IPC communication tests using helpers"
      contains: "use crate::helpers::"
    - path: "tests/orphan_cleanup_tests.rs"
      provides: "Orphan cleanup tests using TestEnvironment"
      contains: "use crate::helpers::"
  key_links:
    - from: "tests/ipc_tests.rs"
      to: "tests/helpers.rs"
      via: "use crate::helpers::*"
      pattern: "use crate::"
    - from: "tests/orphan_cleanup_tests.rs"
      to: "tests/helpers.rs"
      via: "use crate::helpers::TestEnvironment"
      pattern: "let env = TestEnvironment::new()"
</context>

---

<objective>
Refactor ipc_tests.rs and orphan_cleanup_tests.rs to use test helpers

Purpose: Eliminate duplication in IPC roundtrip patterns and temp directory setup, reducing ~50-70 lines per file
Output: Both files updated to use helpers from tests/helpers.rs
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
@.planning/phases/12-test-infrastructure/12-01-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Reference: Original duplication patterns
@tests/ipc_tests.rs                    (all 265 lines)
@tests/orphan_cleanup_tests.rs         (all 241 lines)

# Helpers available from plan 12-01
@tests/helpers.rs
</context>

<tasks>

<task type="auto">
  <name>Refactor ipc_tests.rs to use test helpers</name>
  <files>tests/ipc_tests.rs</files>
  <action>
Update tests/ipc_tests.rs to use helpers from tests/helpers.rs:

1. Add mod declaration at the top:
```rust
#[cfg(test)]
mod helpers;
```

2. Remove local get_test_socket_path() function (lines 16-29)

3. Replace inline path generation in test_ipc_roundtrip (lines 34-44) with:
```rust
let socket_path = crate::helpers::get_test_socket_path_with_suffix("roundtrip");
```

4. Replace inline IPC roundtrip server code (lines 46-73) with helper call. However, this test adds custom timeout behavior, so keep the server code but extract common parts. Replace the server creation and cleanup with:
```rust
let config = crate::helpers::create_test_config_with_socket(socket_path.clone());
```

5. Replace all Config construction with helpers:
```rust
// Old: mcp_cli_rs::config::Config::with_socket_path(socket_path.clone())
// New: crate::helpers::create_test_config_with_socket(socket_path.clone())
```

6. Clean up any other duplicated patterns that match helpers from tests/helpers.rs

Expected lines removed: 30-40 lines through helper reuse
</action>
  <verify>cargo test ipc_tests --lib 2>&1 | tail -20</verify>
  <done>ipc_tests.rs refactored to use helpers, all tests pass</done>
</task>

<task type="auto">
  <name>Refactor orphan_cleanup_tests.rs to use TestEnvironment</name>
  <files>tests/orphan_cleanup_tests.rs</files>
  <action>
Update tests/orphan_cleanup_tests.rs to use TestEnvironment helper:

1. Add mod declaration at the top:
```rust
#[cfg(test)]
mod helpers;
```

2. Remove tempfile::TempDir import (line 9)

3. Replace all TempDir::new() calls with TestEnvironment::new():
```rust
// Old: let temp_dir = TempDir::new().unwrap();
// New: let env = helpers::TestEnvironment::new();
```

4. Replace all temp_dir.path() calls with env.path():
```rust
// Old: temp_dir.path().join("test_orphan.sock")
// New: env.path().join("test_orphan.sock")
```

5. Update tests:
   - test_orphan_socket_cleanup_unix (lines 23-45)
   - test_orphan_socket_cleanup_windows (lines 48-65)
   - test_orphan_pid_file_cleanup (lines 68-86)
   - test_orphan_fingerprint_file_cleanup (lines 89-115+)
   - Any other tests using TempDir

6. Remove temp_dir from scope (TestEnvironment manages cleanup automatically)

Expected lines removed: 15-20 lines through helper reuse
</action>
  <verify>cargo test orphan_cleanup --lib 2>&1 | tail -20</verify>
  <done>orphan_cleanup_tests.rs refactored to use TestEnvironment, all tests pass</done>
</task>

<task type="auto">
  <name>Verify test behavior is identical before and after refactoring</name>
  <files>tests/ipc_tests.rs, tests/orphan_cleanup_tests.rs</files>
  <action>
Run tests to verify behavior is unchanged:

```bash
# Run refactored tests
cargo test ipc_tests::test_ipc_roundtrip --lib
cargo test orphan_cleanup::test_orphan_socket_cleanup --lib -- --show-output

# Verify all tests in both files pass
cargo test ipc_tests --lib
cargo test orphan_cleanup --lib
```

Check that:
1. All tests pass with identical assertions
2. No new warnings or errors introduced
3. Test outputs match expected behavior

If any test fails, debug and fix the helper integration.
</action>
  <verify>cargo test ipc_tests orphan_cleanup --lib 2>&1 | grep -E "(test result|running)"</verify>
  <done>All tests pass with identical behavior verified</done>
</task>

</tasks>

<verification>
After completion, line count comparison:
```bash
wc -l tests/ipc_tests.rs tests/orphan_cleanup_tests.rs
```

Verify tests pass:
```bash
cargo test ipc_tests::test_ipc_roundtrip orphan_cleanup::test_orphan_socket_cleanup --lib
```
</verification>

<success_criteria>
- ipc_tests.rs reduced by ~30-40 lines of duplication
- orphan_cleanup_tests.rs reduced by ~15-20 lines of duplication
- Both files import helpers: `#[cfg(test)] mod helpers;`
- Socket/pipe paths use get_test_socket_path() helper
- Tests use TestEnvironment instead of TempDir::new()
- All tests pass with identical behavior
- No new warnings or errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-test-infrastructure/12-02-SUMMARY.md`
</output>
