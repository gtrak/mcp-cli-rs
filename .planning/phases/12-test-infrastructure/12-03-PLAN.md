---
phase: 12-test-infrastructure
plan: 03
type: execute
wave: 3
depends_on: [12-01]
files_modified: [tests/cross_platform_daemon_tests.rs]
autonomous: true

must_haves:
  truths:
    - "cross_platform_daemon_tests.rs uses helpers from tests/helpers.rs"
    - "Socket/pipe path generators replaced with get_test_socket_path()"
    - "IPC roundtrip patterns use helper functions"
    - "Test configs use factory functions"
    - "All 16 tests pass with identical behavior"
  artifacts:
    - path: "tests/cross_platform_daemon_tests.rs"
      provides: "Cross-platform daemon tests using helpers"
      contains: "use crate::helpers::"
      max_lines: 600  # Reduced from 785 lines
  key_links:
    - from: "tests/cross_platform_daemon_tests.rs"
      to: "tests/helpers.rs"
      via: "use crate::helpers::*"
      pattern: "use crate::"
    - from: "tests/cross_platform_daemon_tests.rs"
      to: "tests/helpers.rs::get_test_socket_path"
      via: "inline path generation replacement"
      pattern: "get_test_socket_path_with_suffix"
</context>

---

<objective>
Refactor cross_platform_daemon_tests.rs to use test helpers

Purpose: Eliminate ~150-200 lines of duplication in the largest test file (785 lines)
Output: All 16 tests (7 Unix, 9 Windows) refactored to use helpers
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
@.planning/phases/12-test-infrastructure/12-01-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Reference: Original file with duplication
@tests/cross_platform_daemon_tests.rs (785 lines)

# Helpers available from plan 12-01
@tests/helpers.rs
</context>

<tasks>

<task type="auto">
  <name>Add helpers module and remove duplicate path generators</name>
  <files>tests/cross_platform_daemon_tests.rs</files>
  <action>
Update tests/cross_platform_daemon_tests.rs:

1. Add mod declaration after imports:
```rust
#[cfg(test)]
mod helpers;
```

2. Remove get_unix_test_socket_path() function (lines 13-18)

3. Remove get_windows_test_pipe_name() function (lines 21-31)

These 19 lines are now replaced by get_test_socket_path() from helpers.rs

Expected lines removed: 19 lines
</action>
  <verify>grep -n "get_unix_test_socket_path\|get_windows_test_pipe_name" tests/cross_platform_daemon_tests.rs || echo "Functions removed successfully"</verify>
  <done>Duplicate path generator functions removed</done>
</task>

<task type="auto">
  <name>Refactor all Unix socket tests to use helpers</name>
  <files>tests/cross_platform_daemon_tests.rs</files>
  <action>
Update all Unix-specific tests to use helpers:

1. test_unix_socket_creation (lines 34-59):
   - Replace socket_path generation with:
     ```rust
     let socket_path = crate::helpers::get_test_socket_path();
     ```
   - Remove inline parent directory creation logic (lines 46-49)
   - Keep assertions but simplify using helper

2. test_unix_socket_client_server_roundtrip (lines 90-153):
   - Replace socket_path with helper
   - Replace Config::default() with create_test_config()
   - Simplify IPC roundtrip code where possible

3. test_unix_socket_multiple_concurrent_connections (lines 156-219):
   - Replace socket_path generation
   - Replace Config construction
   - Simplify client creation

4. test_unix_socket_large_message_transfer (lines 222-310+):
   - Replace socket_path generation
   - Use helper for config if applicable

5. Any other Unix tests in the file

Expected lines removed: 60-80 lines through helper reuse
</action>
  <verify>cargo test test_unix_socket --lib 2>&1 | tail -20</verify>
  <done>All Unix tests refactored to use helpers, tests pass</done>
</task>

<task type="auto">
  <name>Refactor all Windows named pipe tests to use helpers</name>
  <files>tests/cross_platform_daemon_tests.rs</files>
  <action>
Update all Windows-specific tests to use helpers:

1. test_windows_named_pipe_creation (lines 62-87):
   - Replace inline pipe name generation with:
     ```rust
     let pipe_path = crate::helpers::get_test_socket_path();
     ```
   - Simplify assertions (helper guarantees correct format)

2. test_windows_named_pipe_client_server_roundtrip (lines 312-375+):
   - Replace pipe path generation
   - Replace Config construction with helper
   - Simplify roundtrip pattern

3. test_windows_named_pipe_multiple_concurrent_connections (lines 378-440+):
   - Replace pipe path generation
   - Use config helpers

4. test_windows_named_pipe_large_message_transfer (lines 445-530+):
   - Replace pipe path generation
   - Use helpers where applicable

5. Any other Windows tests in the file

Note: Windows tests use String for pipe names, while helpers return PathBuf. The Windows-specific logic in helpers.rs handles this internally via conditional compilation.

Expected lines removed: 60-80 lines through helper reuse
</action>
  <verify>cargo test test_windows_named_pipe --lib 2>&1 | tail -20</verify>
  <done>All Windows tests refactored to use helpers, tests pass</done>
</task>

<task type="auto">
  <name>Verify all 16 tests pass and count line reduction</name>
  <files>tests/cross_platform_daemon_tests.rs</files>
  <action>
Run all tests to verify behavior unchanged:

```bash
# Run all cross-platform daemon tests
cargo test cross_platform_daemon_tests --lib -- --show-output

# Check line count
wc -l tests/cross_platform_daemon_tests.rs
```

Expected results:
- All 16 tests pass (7 Unix, 9 Windows)
- File reduced from 785 lines to ~580-620 lines (~150-200 line reduction)
- No new warnings or errors

If any test fails, debug and fix the integration.
</action>
  <verify> cargo test cross_platform_daemon_tests --lib 2>&1 | grep -E "(test result|running)" && wc -l tests/cross_platform_daemon_tests.rs</verify>
  <done>All 16 tests pass, file reduced by ~150-200 lines</done>
</task>

</tasks>

<verification>
After completion:
```bash
# Line count before vs after
echo "Expected: 785 lines -> 580-620 lines"
wc -l tests/cross_platform_daemon_tests.rs

# Test results
cargo test cross_platform_daemon_tests --lib 2>&1 | grep "test result"
```

Expected: test result: ok. 16 passed
</verification>

<success_criteria>
- cross_platform_daemon_tests.rs reduced by ~150-200 lines (from 785 to ~580-620)
- get_unix_test_socket_path() and get_windows_test_pipe_name() removed
- All socket/pipe path generation uses helper functions
- All Config construction uses factory functions
- All 16 tests pass with identical behavior
- No new warnings or errors
- File compiles cleanly with cargo check --tests
</success_criteria>

<output>
After completion, create `.planning/phases/12-test-infrastructure/12-03-SUMMARY.md`
</output>
