---
phase: 14-duplication-elimination
plan: 03
type: execute
wave: 2
depends_on: ["14-02"]
files_modified:
  - src/cli/list.rs
  - src/cli/info.rs
  - src/cli/call.rs
  - src/cli/search.rs
  - src/cli/commands.rs
  - src/cli/mod.rs
autonomous: true

must_haves:
  truths:
    - "Each command file has a single public function (no separate _json variant)"
    - "Each command function builds a model, then delegates to formatter"
    - "Query logic exists once per command (not duplicated between human/JSON paths)"
    - "All existing output is identical (human and JSON modes produce same output as before)"
  artifacts:
    - path: "src/cli/list.rs"
      provides: "cmd_list_servers with model+formatter pattern, no cmd_list_servers_json"
    - path: "src/cli/info.rs"
      provides: "cmd_server_info and cmd_tool_info with model+formatter, no _json variants"
    - path: "src/cli/call.rs"
      provides: "cmd_call_tool with model+formatter, no cmd_call_tool_json"
    - path: "src/cli/search.rs"
      provides: "cmd_search_tools with model+formatter, no cmd_search_tools_json"
  key_links:
    - from: "src/cli/list.rs"
      to: "src/cli/formatters.rs"
      via: "formatters::format_list_servers"
      pattern: "format_list_servers"
    - from: "src/cli/list.rs"
      to: "src/cli/models.rs"
      via: "models::ListServersModel"
      pattern: "ListServersModel"
---

<objective>
Migrate all 5 command pairs to use Model + Formatter architecture, eliminating duplicate query logic.

Purpose: DUP-01 (consolidate 16→8 functions) and DUP-02 (eliminate duplicate formatting). Each command currently has human+JSON variants with duplicated daemon query logic. After this plan, each command: (1) queries daemon once to build model, (2) delegates to formatter. This eliminates ~200-300 lines of duplication per SIZE-04.

Output: 5 command files (list.rs, info.rs, call.rs, search.rs) refactored to model+formatter. 8 _json functions eliminated.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/14-duplication-elimination/14-CONTEXT.md
@.planning/phases/14-duplication-elimination/14-02-SUMMARY.md
@src/cli/models.rs
@src/cli/formatters.rs
@src/cli/list.rs
@src/cli/info.rs
@src/cli/call.rs
@src/cli/search.rs
@src/cli/commands.rs
@src/cli/mod.rs
@src/cli/command_router.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate list.rs and search.rs to model+formatter</name>
  <files>src/cli/list.rs, src/cli/search.rs, src/cli/commands.rs, src/cli/mod.rs</files>
  <action>
**list.rs refactoring:**
1. Refactor cmd_list_servers to:
   - Remove the early `if output_mode == OutputMode::Json { return cmd_list_servers_json(...) }` branch
   - Extract query logic (lines 66-109) into a private `query_list_servers()` function that returns `ListServersModel`
   - The query function should build ServerModel for each success/failure
   - After query, call `formatters::format_list_servers(&model, detail_level, output_mode)`
   - Delete `cmd_list_servers_json` function entirely
2. The empty config case should also build a model (empty servers list) and format it

**search.rs refactoring:**
1. Refactor cmd_search_tools similarly:
   - Extract query logic into `query_search_results()` returning `SearchResultModel`
   - After query, call `formatters::format_search_results(&model, detail_level, output_mode)`
   - Delete `cmd_search_tools_json` function entirely

**commands.rs and mod.rs:**
1. Remove `cmd_list_servers_json` from re-exports in src/cli/commands.rs
2. Remove `cmd_list_servers_json` from re-exports in src/cli/mod.rs
3. Verify command_router.rs only calls cmd_list_servers (not _json variant) - it already does since the _json dispatch was internal

IMPORTANT: The model construction must capture ALL data that both human and JSON formatters need. Cross-reference with the formatter functions from Plan 02. Test that both `mcp list` and `mcp list --json` produce correct output.

Per locked decision: Breaking changes to internal APIs (no deprecation). Clean break, atomic commit.
  </action>
  <verify>
`cargo check` passes.
`cargo clippy --lib` produces zero warnings.
No `cmd_list_servers_json` or `cmd_search_tools_json` functions exist in codebase.
  </verify>
  <done>
list.rs and search.rs each have single command function using model+formatter. Zero _json duplicates for these commands. Query logic exists once per command.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate info.rs and call.rs to model+formatter</name>
  <files>src/cli/info.rs, src/cli/call.rs</files>
  <action>
**info.rs refactoring (2 commands):**
1. Refactor cmd_server_info:
   - Extract query logic into `query_server_info()` returning `ServerInfoModel`
   - Call `formatters::format_server_info(&model, output_mode)`
   - Delete `cmd_server_info_json`
2. Refactor cmd_tool_info:
   - Extract query logic into `query_tool_info()` returning `ToolInfoModel`
   - Call `formatters::format_tool_info(&model, detail_level, output_mode)`
   - Delete `cmd_tool_info_json`

**call.rs refactoring:**
1. Refactor cmd_call_tool:
   - The retry logic and argument parsing stays in cmd_call_tool
   - After successful tool execution, build `CallResultModel` from the result
   - Call `formatters::format_call_result(&model, output_mode)`
   - Delete `cmd_call_tool_json`
   - Note: The retry/error handling path also needs to produce a model for JSON error output

**Special attention for call.rs:**
- The retry logic (retry_with_backoff) should remain in cmd_call_tool
- Build the model after execution completes (success or final failure)
- The error JSON output (ToolError struct) needs to map to CallResultModel with success=false

Per locked decision: Breaking changes to internal APIs (no deprecation). Clean break, atomic commit.
  </action>
  <verify>
`cargo check` passes.
`cargo clippy --lib` produces zero warnings.
`cargo test` passes all tests.
No `_json` command variants exist in the codebase (search for `_json` in src/cli/*.rs).
  </verify>
  <done>
All 5 command pairs consolidated to 5 single functions. 8 _json functions eliminated. DUP-01 satisfied (16→8 multi-mode commands). DUP-02 satisfied (formatting logic centralized in formatters.rs). All tests pass.
  </done>
</task>

</tasks>

<verification>
- `cargo check` passes
- `cargo clippy --lib` zero warnings
- `cargo test` all tests pass
- `rg "cmd_.*_json" src/cli/` returns NO results
- Each of list.rs, info.rs, call.rs, search.rs has exactly one public command function
- Each command builds a model then calls a formatter function
- JSON and human output modes produce identical results to before
</verification>

<success_criteria>
DUP-01: 16 command functions consolidated to 8 multi-mode commands with OutputMode parameter.
DUP-02: Formatting logic centralized in formatters.rs, no duplicate formatting in command files.
SIZE-04: Command duplication reduced by ~200-300 lines (measure before/after line counts).
All tests pass with identical behavior.
</success_criteria>

<output>
After completion, create `.planning/phases/14-duplication-elimination/14-03-SUMMARY.md`
</output>
