---
phase: 14-duplication-elimination
plan: 04
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/ipc/mod.rs
  - src/daemon/pool.rs
autonomous: true

must_haves:
  truths:
    - "ProtocolClient trait methods are implemented once, not duplicated between IpcClientWrapper methods and ProtocolClient impl"
    - "list_tools, execute_tool, list_servers, shutdown have single implementation path"
    - "pool.rs list_tools and execute methods share MCP initialization logic instead of duplicating it"
  artifacts:
    - path: "src/ipc/mod.rs"
      provides: "ProtocolClient trait with deduplicated implementation"
    - path: "src/daemon/pool.rs"
      provides: "ConnectionPool with shared MCP initialization helper"
  key_links:
    - from: "src/ipc/mod.rs ProtocolClient impl"
      to: "src/ipc/mod.rs IpcClientWrapper methods"
      via: "delegation - impl calls methods instead of duplicating"
      pattern: "self\\.(list_tools|execute_tool|list_servers)"
---

<objective>
Deduplicate connection interface implementations in ipc/mod.rs and daemon/pool.rs.

Purpose: DUP-03 (unify connection interfaces) and DUP-04 (remove duplicate list_tools/call_tool). Currently ipc/mod.rs has IpcClientWrapper methods AND a separate ProtocolClient impl that duplicates the same logic. pool.rs duplicates MCP initialization between list_tools and execute methods.

Output: Single implementation path for each operation. Shared MCP init helper in pool.rs.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/14-duplication-elimination/14-CONTEXT.md
@.planning/phases/14-duplication-elimination/14-01-SUMMARY.md
@src/ipc/mod.rs
@src/daemon/pool.rs
@src/cli/daemon_lifecycle.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deduplicate IpcClientWrapper and ProtocolClient impl in ipc/mod.rs</name>
  <files>src/ipc/mod.rs</files>
  <action>
Currently ipc/mod.rs has TWO implementations of list_servers, list_tools, execute_tool:
1. `impl<T> IpcClientWrapper<T>` (lines 69-143) - inherent methods
2. `impl<T> ProtocolClient for IpcClientWrapper<T>` (lines 170-253) - trait impl that DUPLICATES the same logic

Fix: Have the ProtocolClient trait impl delegate to the inherent methods instead of duplicating:

```rust
#[async_trait]
impl<T: IpcClient + Send + Sync + Clone> ProtocolClient for IpcClientWrapper<T> {
    fn config(&self) -> Arc<Config> {
        Arc::clone(&self.config)
    }
    
    async fn send_request(&mut self, request: &DaemonRequest) -> Result<DaemonResponse, McpError> {
        self.client.send_request(request).await
    }
    
    async fn list_servers(&mut self) -> Result<Vec<String>, McpError> {
        // Delegate to inherent method instead of duplicating
        IpcClientWrapper::list_servers(self).await
    }
    
    async fn list_tools(&mut self, server_name: &str) -> Result<Vec<ToolInfo>, McpError> {
        IpcClientWrapper::list_tools(self, server_name).await
    }
    
    async fn execute_tool(&mut self, server_name: &str, tool_name: &str, arguments: Value) -> Result<Value, McpError> {
        IpcClientWrapper::execute_tool(self, server_name, tool_name, arguments).await
    }
    
    async fn shutdown(&mut self) -> Result<(), McpError> {
        // shutdown is only in trait impl, keep as-is
        let response = self.client.send_request(&DaemonRequest::Shutdown).await?;
        match response {
            DaemonResponse::ShutdownAck => Ok(()),
            _ => Err(McpError::InvalidProtocol { message: format!("Expected ShutdownAck, got {:?}", response) }),
        }
    }
}
```

This removes ~60 lines of duplicated request/response matching logic.

Also add `shutdown()` to IpcClientWrapper inherent methods so trait impl can delegate that too.
  </action>
  <verify>
`cargo check` passes.
`cargo clippy --lib` zero warnings.
  </verify>
  <done>
ProtocolClient trait impl delegates to IpcClientWrapper methods. No duplicated request/response matching. ~60 lines removed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract shared MCP initialization in pool.rs</name>
  <files>src/daemon/pool.rs</files>
  <action>
pool.rs has duplicated MCP initialization in both `execute()` (lines 115-153) and `list_tools()` (lines 204-242). Both send the same initialize request + initialized notification.

Extract a shared helper:

```rust
/// Initialize MCP protocol on a connection (shared between execute and list_tools)
async fn initialize_mcp_connection(transport: &mut BoxedTransport) -> Result<()> {
    let init_request = serde_json::json!({
        "jsonrpc": "2.0",
        "id": 0,
        "method": "initialize",
        "params": {
            "protocolVersion": "2024-11-05",
            "capabilities": { "roots": {}, "sampling": {}, "tools": {} },
            "clientInfo": { "name": "mcp-cli-rs", "version": env!("CARGO_PKG_VERSION") }
        }
    });
    
    transport.send(init_request).await.map_err(|e| McpError::InvalidProtocol {
        message: format!("Initialize request failed: {}", e),
    })?;
    
    let initialized_notification = serde_json::json!({
        "jsonrpc": "2.0",
        "method": "notifications/initialized"
    });
    
    transport.send_notification(initialized_notification).await.map_err(|e| McpError::InvalidProtocol {
        message: format!("Failed to send initialized notification: {}", e),
    })?;
    
    Ok(())
}
```

Then update execute() and list_tools() to call `Self::initialize_mcp_connection(&mut conn.transport).await?;` instead of inline initialization.

This removes ~30 lines of duplication.
  </action>
  <verify>
`cargo check` passes.
`cargo clippy --lib` zero warnings.
`cargo test` all tests pass.
  </verify>
  <done>
pool.rs has shared MCP initialization. execute() and list_tools() use the shared helper. ~30 lines of duplication removed. DUP-04 partially satisfied (duplicate implementations consolidated).
  </done>
</task>

</tasks>

<verification>
- `cargo check` passes
- `cargo clippy --lib` zero warnings
- `cargo test` all tests pass
- In ipc/mod.rs: ProtocolClient impl delegates to IpcClientWrapper methods (no duplicated match arms)
- In pool.rs: Single initialize_mcp_connection helper used by both execute and list_tools
</verification>

<success_criteria>
DUP-03: Connection interface duplication eliminated in ipc/mod.rs (trait impl delegates, not duplicates).
DUP-04: Duplicate list_tools/execute implementations consolidated (pool.rs shares init logic).
ProtocolClient remains the single trait for daemon communication. All tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/14-duplication-elimination/14-04-SUMMARY.md`
</output>
