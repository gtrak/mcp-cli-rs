---
phase: 14-duplication-elimination
plan: 04
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/ipc/mod.rs
  - src/daemon/pool.rs
autonomous: true

must_haves:
  truths:
    - "McpClient trait methods are implemented once, not duplicated between IpcClientWrapper methods and McpClient impl"
    - "list_tools, call_tool, server_info, subscribe, unsubscribe have single implementation path"
    - "pool.rs list_tools and call_tool methods share MCP initialization logic instead of duplicating it"
  artifacts:
    - path: "src/ipc/mod.rs"
      provides: "McpClient trait with deduplicated implementation"
    - path: "src/daemon/pool.rs"
      provides: "ConnectionPool with shared MCP initialization helper"
  key_links:
    - from: "src/ipc/mod.rs McpClient impl"
      to: "src/ipc/mod.rs IpcClientWrapper methods"
      via: "delegation - impl calls methods instead of duplicating"
      pattern: "self\\.(list_tools|call_tool|server_info|subscribe|unsubscribe)"
---

<objective>
Deduplicate connection interface implementations in ipc/mod.rs and daemon/pool.rs.

Purpose: DUP-03 (unify connection interfaces into McpClient trait) and DUP-04 (remove duplicate list_tools/call_tool). Currently ipc/mod.rs has IpcClientWrapper methods AND a separate McpClient impl that duplicates the same logic. pool.rs duplicates MCP initialization between list_tools and call_tool methods.

The McpClient trait must have: list_tools, call_tool, server_info, subscribe, unsubscribe (per locked context).

Output: Single implementation path for each operation. Shared MCP init helper in pool.rs.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/14-duplication-elimination/14-CONTEXT.md
@.planning/phases/14-duplication-elimination/14-01-SUMMARY.md
@src/ipc/mod.rs
@src/daemon/pool.rs
@src/cli/daemon_lifecycle.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deduplicate IpcClientWrapper and McpClient impl in ipc/mod.rs</name>
  <files>src/ipc/mod.rs</files>
  <action>
Currently ipc/mod.rs has TWO implementations of server_info, list_tools, call_tool:
1. `impl<T> IpcClientWrapper<T>` (lines 69-143) - inherent methods
2. `impl<T> McpClient for IpcClientWrapper<T>` (lines 170-253) - trait impl that DUPLICATES the same logic

Fix: Have the McpClient trait impl delegate to the inherent methods instead of duplicating. The McpClient trait must have these methods per DUP-03:
- list_tools
- call_tool
- server_info
- subscribe
- unsubscribe

Rename ProtocolClient to McpClient and have trait impl delegate:

```rust
#[async_trait]
impl<T: IpcClient + Send + Sync + Clone> McpClient for IpcClientWrapper<T> {
    fn config(&self) -> Arc<Config> {
        Arc::clone(&self.config)
    }
    
    async fn send_request(&mut self, request: &DaemonRequest) -> Result<DaemonResponse, McpError> {
        self.client.send_request(request).await
    }
    
    async fn server_info(&mut self, server_name: &str) -> Result<ServerInfo, McpError> {
        // Delegate to inherent method
        IpcClientWrapper::server_info(self, server_name).await
    }
    
    async fn list_tools(&mut self, server_name: &str) -> Result<Vec<ToolInfo>, McpError> {
        IpcClientWrapper::list_tools(self, server_name).await
    }
    
    async fn call_tool(&mut self, server_name: &str, tool_name: &str, arguments: Value) -> Result<Value, McpError> {
        IpcClientWrapper::call_tool(self, server_name, tool_name, arguments).await
    }
    
    async fn subscribe(&mut self, server_name: &str, subscription: Subscription) -> Result<(), McpError> {
        IpcClientWrapper::subscribe(self, server_name, subscription).await
    }
    
    async fn unsubscribe(&mut self, server_name: &str, subscription_id: &str) -> Result<(), McpError> {
        IpcClientWrapper::unsubscribe(self, server_name, subscription_id).await
    }
}
```

This removes ~60 lines of duplicated request/response matching logic. Ensure inherent methods exist for server_info, subscribe, unsubscribe - add if missing.

Note: If ProtocolClient is still used elsewhere, rename to McpClient everywhere for DUP-03 compliance.
  </action>
  <verify>
`cargo check` passes.
`cargo clippy --lib` zero warnings.
  </verify>
  <done>
McpClient trait impl delegates to IpcClientWrapper methods. Trait renamed from ProtocolClient to McpClient with required methods (list_tools, call_tool, server_info, subscribe, unsubscribe). No duplicated request/response matching. ~60 lines removed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract shared MCP initialization in pool.rs</name>
  <files>src/daemon/pool.rs</files>
  <action>
pool.rs has duplicated MCP initialization in both `call_tool()` (lines 115-153) and `list_tools()` (lines 204-242). Both send the same initialize request + initialized notification.

Extract a shared helper:

```rust
/// Initialize MCP protocol on a connection (shared between call_tool and list_tools)
async fn initialize_mcp_connection(transport: &mut BoxedTransport) -> Result<()> {
    let init_request = serde_json::json!({
        "jsonrpc": "2.0",
        "id": 0,
        "method": "initialize",
        "params": {
            "protocolVersion": "2024-11-05",
            "capabilities": { "roots": {}, "sampling": {}, "tools": {} },
            "clientInfo": { "name": "mcp-cli-rs", "version": env!("CARGO_PKG_VERSION") }
        }
    });
    
    transport.send(init_request).await.map_err(|e| McpError::InvalidProtocol {
        message: format!("Initialize request failed: {}", e),
    })?;
    
    let initialized_notification = serde_json::json!({
        "jsonrpc": "2.0",
        "method": "notifications/initialized"
    });
    
    transport.send_notification(initialized_notification).await.map_err(|e| McpError::InvalidProtocol {
        message: format!("Failed to send initialized notification: {}", e),
    })?;
    
    Ok(())
}
```

Then update call_tool() and list_tools() to call `Self::initialize_mcp_connection(&mut conn.transport).await?;` instead of inline initialization.

This removes ~30 lines of duplication.
  </action>
  <verify>
`cargo check` passes.
`cargo clippy --lib` zero warnings.
`cargo test` all tests pass.
  </verify>
  <done>
pool.rs has shared MCP initialization. call_tool() and list_tools() use the shared helper. ~30 lines of duplication removed. DUP-04 partially satisfied (duplicate implementations consolidated).
  </done>
</task>

</tasks>

<verification>
- `cargo check` passes
- `cargo clippy --lib` zero warnings
- `cargo test` all tests pass
- In ipc/mod.rs: McpClient impl delegates to IpcClientWrapper methods (no duplicated match arms)
- In pool.rs: Single initialize_mcp_connection helper used by both call_tool and list_tools
</verification>

<success_criteria>
DUP-03: Connection interface duplication eliminated in ipc/mod.rs (trait renamed to McpClient, impl delegates, not duplicates). McpClient trait has list_tools, call_tool, server_info, subscribe, unsubscribe.
DUP-04: Duplicate list_tools/call_tool implementations consolidated (pool.rs shares init logic).
McpClient is the single trait for daemon communication. All tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/14-duplication-elimination/14-04-SUMMARY.md`
</output>
