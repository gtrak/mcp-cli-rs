---
phase: 14-duplication-elimination
plan: 05
type: execute
wave: 3
depends_on: ["14-03", "14-04"]
files_modified:
  - tests/cli/command_models_test.rs
  - tests/cli/formatters_test.rs
autonomous: true

must_haves:
  truths:
    - "Model tests verify all daemon response fields are captured in model structs"
    - "Formatter tests verify human output contains expected strings"
    - "Formatter tests verify JSON output deserializes to expected structure"
    - "All new tests pass alongside existing test suite"
  artifacts:
    - path: "tests/cli/command_models_test.rs"
      provides: "Tests for ListServersModel, ServerInfoModel, ToolInfoModel, CallResultModel, SearchResultModel construction and serialization"
    - path: "tests/cli/formatters_test.rs"
      provides: "Tests for format_list_servers, format_server_info, format_tool_info, format_call_result, format_search_results"
  key_links:
    - from: "tests/cli/command_models_test.rs"
      to: "src/cli/models.rs"
      via: "use mcp_cli::cli::models::*"
      pattern: "models::"
    - from: "tests/cli/formatters_test.rs"
      to: "src/cli/formatters.rs"
      via: "use mcp_cli::cli::formatters::*"
      pattern: "formatters::"
---

<objective>
Add model and formatter tests per locked test coverage decisions, then verify full phase completion.

Purpose: Per locked decision, tests go in tests/cli/command_models_test.rs and tests/cli/formatters_test.rs. These verify the model+formatter architecture works correctly and catches regressions. Also serves as final DUP-06 verification that all duplicates are eliminated.

Output: Test files with coverage for all 5 command model+formatter pairs. Full phase verification.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/14-duplication-elimination/14-CONTEXT.md
@.planning/phases/14-duplication-elimination/14-03-SUMMARY.md
@.planning/phases/14-duplication-elimination/14-04-SUMMARY.md
@src/cli/models.rs
@src/cli/formatters.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create model and formatter tests</name>
  <files>tests/cli/command_models_test.rs, tests/cli/formatters_test.rs, tests/cli/mod.rs</files>
  <action>
Create tests/cli/ directory if it doesn't exist.

**tests/cli/command_models_test.rs** - Model construction and serialization tests:
For each model type (ListServersModel, ServerInfoModel, ToolInfoModel, CallResultModel, SearchResultModel):
1. Test construction with all fields populated
2. Test JSON serialization produces expected field names (serde_json::to_value then check keys exist)
3. Test JSON round-trip (serialize then deserialize produces same struct)

Example test:
```rust
#[test]
fn test_list_servers_model_serialization() {
    let model = ListServersModel {
        servers: vec![ServerModel { name: "test".into(), status: "connected".into(), ... }],
        total_servers: 1,
        connected_servers: 1,
        failed_servers: 0,
        total_tools: 3,
    };
    let json = serde_json::to_value(&model).unwrap();
    assert_eq!(json["total_servers"], 1);
    assert_eq!(json["servers"][0]["name"], "test");
}
```

**tests/cli/formatters_test.rs** - Formatter output tests:
For each formatter function:
1. Test JSON mode produces valid JSON (capture stdout or test serialization)
2. Test human mode doesn't panic with various inputs (empty, single, multiple items)

Since formatters write to stdout, test the model serialization path (JSON mode) and ensure human mode doesn't panic. For human mode, use models with edge cases:
- Empty lists (no servers, no tools, no matches)
- Single item
- Items with None/missing optional fields

Create tests/cli/mod.rs with:
```rust
mod command_models_test;
mod formatters_test;
```

Ensure tests are properly included in the test binary (check if tests/ has a mod structure or uses individual files).
  </action>
  <verify>
`cargo test command_models` passes all model tests.
`cargo test formatters` passes all formatter tests.
`cargo test` passes ALL tests (full suite).
  </verify>
  <done>
Model tests verify construction and serialization for all 5 model types. Formatter tests verify JSON and human output paths. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Final phase verification and line count</name>
  <files></files>
  <action>
Final verification that all DUP requirements are satisfied:

1. **DUP-01**: Count public command functions in src/cli/{list,info,call,search}.rs - should be 5 (not 10/16). Verify no `_json` variants exist.
2. **DUP-02**: Verify formatters.rs exists and is used by all command files. Check that no command file has inline formatting logic for both modes.
3. **DUP-03**: Verify ipc/mod.rs ProtocolClient impl delegates to IpcClientWrapper (not duplicating).
4. **DUP-04**: Verify pool.rs has shared MCP init helper, no duplicate list_tools/execute logic.
5. **DUP-05**: Verify src/client/transport.rs doesn't exist or is empty.
6. **DUP-06**: General audit - search for obvious remaining duplication patterns.
7. **SIZE-04**: Measure line count reduction. Run `wc -l src/cli/list.rs src/cli/info.rs src/cli/call.rs src/cli/search.rs src/ipc/mod.rs src/daemon/pool.rs` and compare to pre-phase counts (list:460, info:452, call:491, search:413, ipc:327, pool:434 = 2577 total).

Run:
- `cargo check`
- `cargo clippy --lib` (zero warnings)
- `cargo test` (all pass)
- `cargo doc` (check no new warnings introduced)
  </action>
  <verify>
`cargo check` passes.
`cargo clippy --lib` zero warnings.
`cargo test` all pass.
All 6 DUP requirements verified.
  </verify>
  <done>
Phase 14 complete. DUP-01 through DUP-06 and SIZE-04 satisfied. All tests pass. Model+formatter architecture in place. Connection interfaces deduplicated. Transport consolidated.
  </done>
</task>

</tasks>

<verification>
- All DUP-01 through DUP-06 requirements verified
- SIZE-04: Command duplication reduced by 200-300 lines (measured)
- `cargo check` clean
- `cargo clippy --lib` zero warnings
- `cargo test` all pass
- New test files exist at tests/cli/command_models_test.rs and tests/cli/formatters_test.rs
</verification>

<success_criteria>
Phase 14 Duplication Elimination fully complete:
- DUP-01: 16â†’8 multi-mode commands (5 functions, OutputMode parameter)
- DUP-02: Formatting centralized in formatters.rs
- DUP-03: ProtocolClient impl delegates, no duplication
- DUP-04: pool.rs shared MCP init, no duplicate operations
- DUP-05: Single transport trait in src/transport.rs
- DUP-06: All duplicate interfaces eliminated
- SIZE-04: ~200-300 lines reduced
- Model and formatter tests provide regression coverage
</success_criteria>

<output>
After completion, create `.planning/phases/14-duplication-elimination/14-05-SUMMARY.md`
</output>
