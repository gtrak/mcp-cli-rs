---
phase: 06-output-formatting
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/cli/commands.rs
autonomous: true
must_haves:
  truths:
    - "Tool info command shows consistent formatting with list command"
    - "Grep/search results show server context and tool descriptions"
    - "Both commands use the same formatting utilities"
    - "Detail level flags work consistently across commands"
  artifacts:
    - path: "src/cli/commands.rs"
      provides: "Updated info and grep commands"
      contains: ["cmd_tool_info", "cmd_search_tools", "DetailLevel"]
  key_links:
    - from: "cmd_tool_info"
      to: "src/format/params.rs"
      via: "format_param_list import"
      pattern: "format_param_list"
    - from: "cmd_search_tools"
      to: "src/format/params.rs"
      via: "format_param_list import"
      pattern: "format_param_list"
---

<objective>
Update tool info and grep commands with consistent formatting, context-rich search results, and detail level support.

Purpose: Ensure all discovery commands (list, info, grep) share consistent formatting patterns and provide appropriate context for user navigation.
Output: Enhanced cmd_tool_info and cmd_search_tools with unified formatting and detail levels.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/06-output-formatting/06-01-SUMMARY.md
@.planning/phases/06-output-formatting/06-02-SUMMARY.md
@src/cli/commands.rs

**Requirements to implement:**
- OUTP-05: Consistent formatting across all commands
- OUTP-14: Tool search results show context (server name + tool description)
- OUTP-02: Progressive detail levels work across all commands
- OUTP-11: Tool descriptions prominently displayed

**Current implementations:**
- `cmd_tool_info`: Shows tool name, description, and full JSON Schema
- `cmd_search_tools`: Shows server name and matching tools with descriptions

**Inconsistencies to fix:**
- Tool info shows raw JSON Schema (not formatted)
- Search results don't show parameter info
- No detail level support in these commands
- Different formatting styles between commands
</context>

<tasks>

<task type="auto">
  <name>Update tool info command with formatted output</name>
  <files>src/cli/commands.rs</files>
  <action>
Rewrite `cmd_tool_info` to use consistent formatting:

1. Update function signature to accept DetailLevel:
   ```rust
   pub async fn cmd_tool_info(
       mut daemon: Box<dyn ProtocolClient>, 
       tool_id: &str,
       detail_level: DetailLevel
   ) -> Result<()>
   ```

2. Add structured header with visual hierarchy:
   ```
   Tool: tool_name
   ════════════════════════════════════════
   Server: server_name (transport_type)
   ```

3. Format based on detail_level:
   
   **Summary level:**
   ```
   Description: [description or "No description available"]
   
   Parameters: param1 <string> param2 [number]
   
   Use -d for parameter details, -v for full schema
   ```
   
   **WithDescriptions level (-d):**
   ```
   Description: [full description]
   
   Parameters:
     param1 <string>  Required. [description]
     param2 [number]  Optional. [description]
   
   Usage: mcp call server/tool '{"param1": "value"}'
   ```
   
   **Verbose level (-v):**
   - Include all of WithDescriptions
   - Add full JSON Schema in formatted block:
     ```
     JSON Schema:
     {
       "type": "object",
       "properties": { ... },
       "required": ["param1"]
     }
     ```
   - Show examples if available in schema

4. Use format module functions:
   - `extract_params_from_schema` to parse input_schema
   - `format_param_list` for parameter display
   - Match the visual style from cmd_list_servers

5. Add helpful messages:
   - If tool has no description: "No description available for this tool"
   - If tool has no parameters: "This tool takes no parameters"
   - Show usage example: `mcp call {server}/{tool} [args]`

6. Update callers of cmd_tool_info to pass DetailLevel:
   - Map CLI flags same as list command
   - Find in main.rs or wherever CLI parsing happens

Ensure consistency with list command:
- Same header style (bold tool name, separator line)
- Same parameter formatting (<required> [optional])
- Same color scheme and spacing
- Same usage hints pattern
  </action>
  <verify>
cargo check 2>&1 | grep -E "(error|warning)" | head -20
cargo test cmd_tool_info 2>&1 | tail -20
  </verify>
  <done>
cmd_tool_info displays tool info with consistent formatting, shows parameters in help-style format, supports all detail levels, and provides helpful usage hints.
  </done>
</task>

<task type="auto">
  <name>Update search/grep command with context-rich results</name>
  <files>src/cli/commands.rs</files>
  <action>
Rewrite `cmd_search_tools` to show context-rich results:

1. Update function signature:
   ```rust
   pub async fn cmd_search_tools(
       mut daemon: Box<dyn ProtocolClient>, 
       pattern: &str,
       detail_level: DetailLevel
   ) -> Result<()>
   ```

2. Add search summary header:
   ```
   Search Results for 'pattern'
   ════════════════════════════════════════
   Found N matching tool(s) across M server(s)
   ```

3. For each matching server, display context:
   ```
   server_name (transport_type)
   ────────────────────────────
   • tool_name: Brief description...
     Parameters: param1 <type> param2 [type]
   
   • another_tool: Description...
     Parameters: none
   ```
   
   Use the same formatting as cmd_list_servers for consistency.

4. Implement detail level variations:
   
   **Summary (default):**
   - Show tool name with bullet
   - Show truncated description (60 chars max)
   - Show parameter overview
   - Show server name prominently
   
   **WithDescriptions (-d):**
   - Full descriptions
   - Detailed parameter list with descriptions
   - Group by server with clear headers
   
   **Verbose (-v):**
   - Include parameter details
   - Show full schema for each tool
   - More comprehensive but still readable

5. Handle edge cases:
   - No matches: "No tools matching 'pattern' found. Try a different search term."
   - Single match: "Found 1 matching tool"
   - Partial server failures: Show under "⚠ Search limited" section
   - Empty pattern: "Please provide a search pattern (e.g., 'mcp grep search*')"

6. Add helpful footer:
   ```
   ────────────────────────────────────────
   Use 'mcp info server/tool' for detailed tool information
   ```

7. Update callers to pass DetailLevel parameter

Use consistent visual elements:
- Same server header style as list command
- Same bullet points and indentation
- Same color scheme (bold for names, dimmed for meta)
- Same separator line style

This implements OUTP-14: context-rich search results with server + tool + description.
  </action>
  <verify>
cargo check 2>&1 | grep -E "(error|warning)" | head -20
cargo test cmd_search_tools 2>&1 | tail -20
  </verify>
  <done>
cmd_search_tools displays context-rich results with server names, tool descriptions, and parameter info; supports all detail levels; handles edge cases gracefully.
  </done>
</task>

</tasks>

<verification>
1. Tool info command uses consistent formatting with list command
2. Search results show server context and descriptions
3. Both commands support all detail levels
4. Formatting is visually consistent (headers, bullets, colors)
5. Helpful messages guide users to next steps
6. Code compiles and tests pass
7. No breaking changes to existing behavior
</verification>

<success_criteria>
- cmd_tool_info uses DetailLevel parameter
- Tool info displays parameters in help-style format
- Search results show server + tool + description context
- Both commands use consistent visual styling
- Empty/no-match states have helpful messages
- Usage hints guide users to related commands
- All detail levels work correctly across commands
</success_criteria>

<output>
After completion, create `.planning/phases/06-output-formatting/06-03-SUMMARY.md`
</output>
