---
phase: 06-output-formatting
plan: 04
type: execute
wave: 3
depends_on: ["06-02", "06-03"]
files_modified:
  - src/output.rs
  - src/cli/commands.rs
  - src/main.rs
autonomous: true
must_haves:
  truths:
    - "Error messages maintain consistent format with context and suggestions"
    - "Warnings are visually distinct but not overwhelming"
    - "CLI flags (--json, --describe, --verbose) are properly wired"
    - "All commands respect output formatting flags"
  artifacts:
    - path: "src/output.rs"
      provides: "Enhanced error/warning display functions"
      exports: ["print_formatted_error", "print_formatted_warning"]
    - path: "src/main.rs"
      provides: "CLI flag wiring"
      contains: ["--json", "--describe", "--verbose"]
    - path: "src/cli/commands.rs"
      provides: "Consistent error display in all commands"
  key_links:
    - from: "src/main.rs"
      to: "cmd_list_servers"
      via: "DetailLevel argument"
      pattern: "DetailLevel::"
---

<objective>
Enhance error/warning display and wire CLI flags for detail levels and output modes.

Purpose: Ensure consistent, helpful error messages across all commands and properly integrate CLI flags (--describe, --verbose) with the formatting system.
Output: Enhanced error formatting utilities and wired CLI flags for all commands.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/06-output-formatting/06-02-SUMMARY.md
@.planning/phases/06-output-formatting/06-03-SUMMARY.md
@src/output.rs
@src/main.rs
@src/cli/commands.rs

**Requirements to implement:**
- OUTP-16: Error messages maintain consistent format with context and suggestions
- OUTP-17: Warnings are visually distinct but not overwhelming
- OUTP-02: Progressive detail levels via CLI flags
- OUTP-05: Consistent formatting across all commands

**Current state:**
- Basic error/warning functions exist (print_error, print_warning in output.rs)
- Commands have inconsistent error display
- CLI flags need to be wired to DetailLevel
- No structured error format with context

**What needs enhancement:**
- Error messages need context (what failed, why, how to fix)
- Warnings should be noticeable but not distracting
- CLI flags --describe (-d) and --verbose (-v) need to work
- All commands need to respect detail levels
</context>

<tasks>

<task type="auto">
  <name>Enhance error and warning display functions</name>
  <files>src/output.rs</files>
  <action>
Enhance `src/output.rs` with structured error/warning display:

1. Add `print_formatted_error` function:
   ```rust
   pub fn print_formatted_error(context: &str, message: &str, suggestion: Option<&str>)
   ```
   
   Format:
   ```
   ✗ [Context] Error message here
     Suggestion: Try this to fix it
   ```
   
   - Context in brackets: "Configuration", "Connection", "Tool Execution", etc.
   - Message in regular text
   - Suggestion on new line with "Suggestion:" prefix (if provided)
   - Use red for the ✗ symbol, yellow for suggestion

2. Add `print_formatted_warning` function:
   ```rust
   pub fn print_formatted_warning(context: &str, message: &str)
   ```
   
   Format:
   ```
   ⚠ [Context] Warning message here
   ```
   
   - Yellow ⚠ symbol
   - Context in brackets
   - Message in dimmed yellow
   - Keep it compact - one or two lines max

3. Add helper function for partial failures:
   ```rust
   pub fn print_partial_failures(context: &str, failures: &[(String, String)])
   ```
   
   Format:
   ```
   ⚠ [Context] Some operations failed (2 of 5)
   
   Failed items:
     ✗ item1: Connection refused
     ✗ item2: Timeout after 30s
   
   Successful items:
     ✓ item3
     ✓ item4
     ✓ item5
   ```

4. Keep existing simple functions (print_error, print_warning) for backward compatibility but mark them as deprecated in comments.

5. Update all existing calls in commands.rs to use new formatted versions:
   - Replace simple error messages with context + suggestion
   - Group related warnings
   - Use partial failure display where applicable

6. Add tests for new functions:
   - Test with all parameters
   - Test with None suggestion
   - Test partial failures with empty list

Examples of usage:
- Config error: `print_formatted_error("Configuration", "No servers configured", Some("Create mcp_servers.toml in current directory"))`
- Connection warning: `print_formatted_warning("Connection", "Server 'xyz' is slow to respond")`
- Partial failures: `print_partial_failures("Discovery", &[("server1", "Connection refused"), ("server2", "Timeout")])`
  </action>
  <verify>
cargo test output:: 2>&1 | tail -20
cargo check 2>&1 | grep -E "(error|warning)" | head -10
  </verify>
  <done>
New formatted error/warning functions added, existing functions kept for compatibility, tests pass for new functions.
  </done>
</task>

<task type="auto">
  <name>Wire CLI flags for detail levels</name>
  <files>src/main.rs, src/cli/mod.rs</files>
  <action>
Wire the CLI flags to DetailLevel enum in the main entry point:

1. Check current CLI structure in `src/main.rs`:
   - Look for clap derive macros or builder pattern
   - Find where commands are defined and dispatched

2. Add CLI flags to relevant commands (list, info, grep):
   ```rust
   #[arg(short = 'd', long = "describe", help = "Show detailed descriptions")]
   describe: bool,
   
   #[arg(short = 'v', long = "verbose", help = "Show verbose output with full schema")]
   verbose: bool,
   ```

3. Create helper function to convert flags to DetailLevel:
   ```rust
   fn detail_level_from_flags(describe: bool, verbose: bool) -> DetailLevel {
       if verbose {
           DetailLevel::Verbose
       } else if describe {
           DetailLevel::WithDescriptions
       } else {
           DetailLevel::Summary
       }
   }
   ```

4. Update command dispatch to pass DetailLevel:
   - In main.rs command handler, convert flags to DetailLevel
   - Pass to cmd_list_servers, cmd_tool_info, cmd_search_tools
   - Ensure all three commands receive the same detail level

5. Update command help text:
   - Add examples showing -d and -v usage
   - Document what each level shows
   - Example: `mcp list -d` shows descriptions, `mcp list -v` shows full schema

6. Ensure flags work consistently:
   - `-d` and `--describe` are equivalent
   - `-v` and `--verbose` are equivalent
   - If both -d and -v provided, -v takes precedence (most verbose)
   - Flags work on list, info, and grep commands

7. Test CLI flag parsing:
   - Verify clap generates proper help text
   - Test that flags are recognized
   - Verify no conflicts between short flags

The commands that should support these flags:
- `mcp` (list command, default)
- `mcp list`
- `mcp info <server/tool>`
- `mcp grep <pattern>`
  </action>
  <verify>
cargo build 2>&1 | grep -E "(error|warning)" | head -10
./target/debug/mcp-cli-rs --help 2>&1 | grep -E "(-d|--describe|-v|--verbose)"
./target/debug/mcp-cli-rs list --help 2>&1 | grep -E "(-d|--describe|-v|--verbose)"
  </verify>
  <done>
CLI flags -d/--describe and -v/--verbose are wired to all discovery commands (list, info, grep), DetailLevel is properly passed through the call chain, help text shows flag descriptions.
  </done>
</task>

<task type="auto">
  <name>Update command error messages with new format</name>
  <files>src/cli/commands.rs</files>
  <action>
Update all error and warning messages in commands.rs to use the new formatted output:

1. Update error messages in cmd_list_servers:
   - Current: `print_error("No servers configured. Please create a config file.");`
   - New: `print_formatted_error("Configuration", "No servers configured", Some("Create mcp_servers.toml with your MCP server definitions"));`
   
   - Current: `print_error(&format!("Failed to get servers list: {}", e));`
   - New: `print_formatted_error("Connection", &format!("Failed to retrieve server list: {}", e), Some("Check daemon status with 'mcp status'"));`

2. Update warning messages:
   - Current: `print_warning(&format!("Failed to connect to {} servers...", failures.len()));`
   - New: `print_formatted_warning("Discovery", &format!("{} of {} servers failed to connect", failures.len(), total));`
   
   - Add more context to filtering warnings

3. Update cmd_tool_info error messages:
   - Server not found: Add context "Configuration", suggestion "Use 'mcp' to list available servers"
   - Tool not found: Add context "Discovery", suggestion "Use 'mcp info server' to see available tools"
   - JSON parse errors: Add context "Input", suggestion about valid JSON format

4. Update cmd_search_tools error messages:
   - No matches: Add suggestion for broader search patterns
   - Pattern errors: Explain glob pattern syntax
   - Connection errors: Similar to list command

5. Update cmd_call_tool error messages:
   - Server not found: Configuration context
   - Tool not found: Discovery context  
   - Invalid JSON: Input context with example
   - Tool disabled: Security context with configuration suggestion
   - Execution failures: Execution context with retry suggestion

6. Update cmd_server_info error messages:
   - Server not found: Configuration context

Ensure all error messages follow the pattern:
- Context in brackets: Configuration, Connection, Discovery, Input, Execution, Security
- Clear error description
- Actionable suggestion when applicable

Use the new functions from output.rs:
- `print_formatted_error` for all error conditions
- `print_formatted_warning` for warnings
- Keep message text concise but informative
  </action>
  <verify>
cargo check 2>&1 | grep -E "(error|warning)" | head -20
cargo test 2>&1 | tail -10
  </verify>
  <done>
All error and warning messages in commands.rs use new formatted output with context and suggestions, code compiles, tests pass.
  </done>
</task>

</tasks>

<verification>
1. New formatted error/warning functions work correctly
2. CLI flags -d and -v are recognized and passed to commands
3. All error messages have context and suggestions
4. Warnings are distinct but not overwhelming
5. Detail levels work consistently across list, info, and grep
6. Code compiles without errors
7. Tests pass for new functionality
</verification>

<success_criteria>
- print_formatted_error and print_formatted_warning functions added to output.rs
- All error messages include context and actionable suggestions
- Warning messages are visually distinct but concise
- CLI flags --describe (-d) and --verbose (-v) work on all discovery commands
- DetailLevel is properly passed through the command chain
- Consistent error format across all commands
- Tests pass for new formatting functions
</success_criteria>

<output>
After completion, create `.planning/phases/06-output-formatting/06-04-SUMMARY.md`
</output>
