---
phase: 24-linux-compatibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
autonomous: true

must_haves:
  truths:
    - "cargo build compiles on Linux without dependency errors"
    - "windows-sys is only compiled on Windows targets"
    - "nix crate is available for Unix signal handling"
  artifacts:
    - path: "Cargo.toml"
      provides: "Dependency declarations with proper platform gating"
      contains: "[target.'cfg(windows)'.dependencies]"
    - path: "Cargo.toml"
      provides: "nix crate for Unix"
      contains: "nix ="
  key_links:
    - from: "Cargo.toml"
      to: "Cargo.lock"
      via: "cargo update"
      pattern: "nix.*crate"
---

<objective>
Fix Cargo.toml dependencies for Linux compatibility by adding platform-specific gating.

Purpose: Enable the project to compile on Linux by making Windows-only dependencies conditional and adding Unix-specific dependencies for signal handling.

Output: Updated Cargo.toml with proper `cfg(windows)` and `cfg(unix)` gated dependencies.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@Cargo.toml

## Current State
Cargo.toml has `windows-sys` as an unconditional dependency (line 16), which causes compilation failures on Linux. The `nix` crate is missing for Unix signal handling.

## Requirements Coverage
- LINUX-04: Add nix crate dependency for Unix signal handling
- LINUX-09: Make windows-sys dependency Windows-only
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make windows-sys Windows-only</name>
  <files>Cargo.toml</files>
  <action>
Move the `windows-sys` dependency from `[dependencies]` to `[target.'cfg(windows)'.dependencies]` section.

Current (line 16):
```toml
windows-sys = { version = "0.61", features = ["Win32_System_Threading"] }
```

Change to:
```toml
[target.'cfg(windows)'.dependencies]
windows-sys = { version = "0.61", features = ["Win32_System_Threading"] }
```

This ensures windows-sys is only compiled on Windows targets, fixing LINUX-09.
  </action>
  <verify>grep -A1 "\[target.'cfg(windows)'.dependencies\]" Cargo.toml | grep "windows-sys"</verify>
  <done>windows-sys dependency is under [target.'cfg(windows)'.dependencies] section</done>
</task>

<task type="auto">
  <name>Task 2: Add nix crate for Unix</name>
  <files>Cargo.toml</files>
  <action>
Add a `[target.'cfg(unix)'.dependencies]` section with the nix crate for Unix signal handling.

Add after the windows dependencies section:
```toml
[target.'cfg(unix)'.dependencies]
nix = { version = "0.29", features = ["signal", "process"] }
```

This provides Unix-specific signal handling capabilities needed for proper daemon process management on Linux, fixing LINUX-04.
  </action>
  <verify>grep -A1 "\[target.'cfg(unix)'.dependencies\]" Cargo.toml | grep "nix"</verify>
  <done>nix crate is declared under [target.'cfg(unix)'.dependencies] section</done>
</task>

<task type="auto">
  <name>Task 3: Update Cargo.lock</name>
  <files>Cargo.lock</files>
  <action>
Run `cargo update` to regenerate Cargo.lock with the new dependency structure. This ensures the lockfile reflects the platform-specific dependencies.
  </action>
  <verify>cargo update</verify>
  <done>Cargo.lock updated with nix crate entries</done>
</task>

</tasks>

<verification>
After this plan completes:
1. `cargo check` should succeed without "unresolved import" errors for windows-sys on Linux
2. Cargo.toml should have platform-gated dependency sections
3. Both windows-sys and nix crates appear in Cargo.lock
</verification>

<success_criteria>
- [ ] windows-sys is under [target.'cfg(windows)'.dependencies]
- [ ] nix is under [target.'cfg(unix)'.dependencies]  
- [ ] cargo check runs without dependency errors
- [ ] LINUX-04 and LINUX-09 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/24-linux-compatibility/24-01-SUMMARY.md` documenting:
- Dependency changes made
- Platform gating applied
- Verification results
</output>
