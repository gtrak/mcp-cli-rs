---
phase: 24-linux-compatibility
plan: 03
type: execute
wave: 1
depends_on: [24-02]
files_modified:
  - src/ipc/unix.rs
  - src/error.rs
autonomous: true

must_haves:
  truths:
    - "Unix socket address handling compiles on Linux"
    - "All McpError variants covered in exit_code match for Unix"
    - "cargo build succeeds on Linux"
  artifacts:
    - path: "src/ipc/unix.rs"
      provides: "Socket address to string conversion"
      contains: "addr.as_pathname()"
    - path: "src/error.rs"
      provides: "Complete exit_code match for Unix"
      contains: "DaemonNotRunning"
  key_links:
    - from: "src/error.rs exit_code"
      to: "McpError::DaemonNotRunning"
      via: "match arm"
      pattern: "DaemonNotRunning"
---

<objective>
Fix remaining Linux compatibility issues in Unix IPC and error handling.

Purpose: Address two remaining compilation issues on Linux:
1. Unix socket address `to_string_lossy()` - SocketAddr doesn't have this method
2. Missing `DaemonNotRunning` in Unix exit_code match arm

Output: Fixed src/ipc/unix.rs and src/error.rs for Linux compilation.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@src/ipc/unix.rs
@src/error.rs

## Current State
1. src/ipc/unix.rs line 62: `addr.to_string_lossy()` - Unix SocketAddr doesn't have to_string_lossy()
2. src/error.rs lines 158-179: Unix exit_code match missing DaemonNotRunning variant (it's in the Windows version at line 207 but not Unix)

## Requirements Coverage
- LINUX-07: Unix socket address handling uses platform-appropriate APIs
- LINUX-08: Error handling covers all McpError variants exhaustively
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Unix socket address display</name>
  <files>src/ipc/unix.rs</files>
  <action>
Fix line 62 in src/ipc/unix.rs where `addr.to_string_lossy()` is called on a `SocketAddr`.

Unix SocketAddr (from tokio::net::unix::SocketAddr) doesn't have `to_string_lossy()`. It has `as_pathname()` which returns `Option<&Path>`.

Change line 62 from:
```rust
addr.to_string_lossy().to_string()
```

To:
```rust
addr.as_pathname()
    .map(|p| p.display().to_string())
    .unwrap_or_else(|| "unknown".to_string())
```

This properly handles the Unix socket address by converting the Path to a displayable string, with a fallback for cases where the pathname isn't available.
  </action>
  <verify>grep -A2 "addr.as_pathname" src/ipc/unix.rs</verify>
  <done>Unix socket address uses as_pathname() instead of to_string_lossy()</done>
</task>

<task type="auto">
  <name>Task 2: Add DaemonNotRunning to Unix exit_code</name>
  <files>src/error.rs</files>
  <action>
Add `DaemonNotRunning` to the Unix exit_code match arm in src/error.rs.

Current Unix exit_code (lines 158-179) is missing DaemonNotRunning which exists in the Windows version.

Add DaemonNotRunning to the first match arm (client errors) around line 168:
```rust
McpError::ServerNotFound { .. }
| McpError::ToolNotFound { .. }
| McpError::ConfigReadError { .. }
| McpError::ConfigParseError { .. }
| McpError::MissingRequiredField { .. }
| McpError::InvalidJson { .. }
| McpError::AmbiguousCommand { .. }
| McpError::UsageError { .. }
| McpError::OperationCancelled { .. }
| McpError::MaxRetriesExceeded { .. }
| McpError::DaemonNotRunning { .. } => 1, // Client error
```

This ensures all error variants are handled exhaustively on Unix.
  </action>
  <verify>grep -B5 -A1 "DaemonNotRunning" src/error.rs | grep "=> 1"</verify>
  <done>DaemonNotRunning added to Unix exit_code match arm</done>
</task>

<task type="auto">
  <name>Task 3: Verify full Linux build</name>
  <files>Cargo.toml</files>
  <action>
Run `cargo build` to verify the project compiles successfully on Linux without any errors.

This validates:
- All dependencies resolve correctly
- All platform-specific code compiles
- No unresolved imports or missing match arms
  </action>
  <verify>cargo build 2>&1 | tail -20</verify>
  <done>cargo build succeeds with no errors</done>
</task>

</tasks>

<verification>
After this plan completes:
1. `cargo build` succeeds on Linux
2. No compilation errors for Unix-specific code
3. All error variants handled in exit_code
</verification>

<success_criteria>
- [ ] Unix socket address uses proper API (as_pathname)
- [ ] DaemonNotRunning in Unix exit_code match
- [ ] cargo build succeeds
- [ ] LINUX-07 and LINUX-08 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/24-linux-compatibility/24-03-SUMMARY.md` documenting:
- Socket address fix applied
- Error handling fix applied
- Build verification results
</output>
