---
phase: 08-fix-windows-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/windows_process_spawn_tests.rs
autonomous: true
must_haves:
  truths:
    - "Integration tests for Windows process spawning compile without errors"
    - "CLI command execution tests verify clean shutdown"
    - "Concurrent process spawning (5 parallel) validates cleanup"
    - "Process timeout scenarios demonstrate kill_on_drop behavior"
    - "Daemon process cleanup (3 lifecycle cycles) produces no orphans"
    - "Multiple tools concurrent execution validates process management"
    - "Batch tool execution (20 processes) cleans up all processes"
    - "Error handling in batch operations doesn't leave zombies"
    - "Tokio timeout integration confirms process termination"
    - "Cleanup after send failures drops handles correctly"
  artifacts:
    - path: "tests/windows_process_spawn_tests.rs"
      provides: "Integration tests for Windows process spawning validation"
      min_lines: 400
      contains: "windows_process_spawn_tests"
  key_links:
    - from: "tests/windows_process_spawn_tests.rs"
      to: "tokio::io::AsyncBufReadExt"
      via: "use tokio::io::AsyncBufReadExt"
      pattern: "use tokio::io::AsyncBufReadExt"
    - from: "tests/windows_process_spawn_tests.rs"
      to: "tokio::process::Command"
      via: "tokio::process::Command::new"
      pattern: "tokio::process::Command::new"
---

<objective>
Create missing Windows process spawning integration tests (tests/windows_process_spawn_tests.rs) to complete XP-01 validation.

Purpose: The 04-02-PLAN.md promised 2 test files: windows_process_tests.rs (unit tests - created) and windows_process_spawn_tests.rs (integration tests - missing). This plan creates the missing integration test file with 9 real-world process cleanup scenarios, ensuring proper compilation and validation of kill_on_drop(true) behavior on Windows.

Output: Complete integration test suite (tests/windows_process_spawn_tests.rs) covering CLI execution, concurrency, timeouts, daemon cleanup, batch operations, and error scenarios.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md

@tests/windows_process_tests.rs
@src/client/stdio.rs
@.planning/phases/04-tool-filtering/04-02-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Windows process spawning integration tests</name>
  <files>tests/windows_process_spawn_tests.rs</files>
  <action>
Create the missing integration test file tests/windows_process_spawn_tests.rs with the following structure and test scenarios:

## File Header and Module Declaration
```rust
//! Windows process spawning integration tests.
//!
//! This module provides real-world validation of tokio::process::Command with
//! kill_on_drop(true) preventing zombie processes on Windows (XP-01).
//!
//! These are integration tests covering CLI, daemon, concurrent, and error scenarios.
//! Must be run with `cargo test process_cleanup -- --ignored`.

#[cfg(test)]
#[cfg(windows)]
mod windows_process_spawn_tests {
    use std::time::Duration;
    use tokio::io::{AsyncBufReadExt, AsyncWriteExt, BufReader};
```

## Test 1: CLI command execution with shutdown
Create `test_cli_command_execution_with_shutdown`:
- Spawn a simple CLI-like process (e.g., `cmd.exe /c echo test_result`)
- Read stdout using BufReader with AsyncBufReadExt trait
- Verify output contains expected result
- Explicitly kill and wait for process
- Verify no zombie processes remain

## Test 2: Concurrent process spawning (5 parallel)
Create `test_concurrent_process_spawning`:
- Use tokio::spawn to create 5 concurrent tasks
- Each task spawns a unique process with distinct output
- Use tokio::select! or join_all to wait for all tasks
- Drop all child handles randomly (simulating real async patterns)
- Verify all processes terminated after drops

## Test 3: Process timeout scenarios
Create `test_process_timeout_scenarios`:
- Spawn a long-running process (e.g., `timeout 10` or `ping -n 10 localhost`)
- Use tokio::time::timeout with 2-3 second limit
- Verify timeout fires and prevents hanging
- Explicitly drop the child handle via kill() after timeout
- Confirm process is killed and no zombie remains

## Test 4: Daemon process cleanup (3 lifecycle cycles)
Create `test_daemon_process_cleanup_lifecycle`:
- Simulate daemon-like lifecycle: spawn, process, shutdown
- Repeat 3 times in a loop
- Each iteration: spawn daemon, read some output, kill/shutdown
- Verify no orphaned daemon processes remain after 3 cycles
- Use process ID tracking if needed for verification

## Test 5: Multiple tools concurrent execution
Create `test_multiple_tools_concurrent_execution`:
- Spawn 3-5 "tool" processes in parallel (async tasks)
- Each tool reads stdin and writes specific output
- Use tokio::join_all to wait for all completions
- Verify all tool outputs are distinct and correct
- Drop all handles and verify clean cleanup

## Test 6: Batch tool execution cleanup (20 processes)
Create `test_batch_tool_execution_cleanup`:
- Spawn 20 processes sequentially in a loop
- Each process: spawn, read minimal output, kill
- Keep track of all child handles in a Vec
- After all spawned, drop Vec (all handles)
- Verify no zombies remain

## Test 7: Error handling in batch operations
Create `test_error_handling_in_batch_operations`:
- Spawn 10 processes, half valid and half intentionally invalid
- Invalid processes: use non-existent commands or invalid args
- Use error handling (expect or Result) for spawn failures
- Verify spawn failures don't leave zombie handles
- Verify valid processes still complete normally

## Test 8: Tokio timeout integration
Create `test_tokio_timeout_integration`:
- Spawn a process that waits indefinitely (`timeout 9999`)
- Use tokio::time::timeout with 500ms limit
- On timeout, kill the process via child.kill()
- Wait for process to exit with try_wait or wait()
- Confirm no zombie after kill + exit

## Test 9: Cleanup after send failures
Create `test_cleanup_after_send_failures`:
- Spawn process with stdin but closed stdout
- Attempt to write to stdin using AsyncWriteExt
- Simulate send failure (broken pipe or process exits early)
- Verify child handle is dropped even after send error
- Confirm no zombie process remains after failure

**Important Implementation Details:**

1. **Imports:** Use `tokio::io::{AsyncBufReadExt, AsyncWriteExt, BufReader}` for async I/O traits
2. **Process Creation:** `tokio::process::Command::new("cmd.exe").args(["/c", ...]).kill_on_drop(true).spawn()`
3. **Output Reading:** `BufReader::new(stdout).read_line(&mut line).await`
4. **Writing to Processes:** `stdin.write_all(b"input").await.flush().await`
5. **Async Tests:** All tests marked `#[tokio::test]` and `#[ignore]`
6. **Platform Specific:** Module wrapped in `#[cfg(windows)]`
7. **Test Duration:** Add `tokio::time::sleep` for cleanup verification (500-1000ms)
8. **Error Handling:** Use `expect()` with descriptive messages where appropriate for test failures

**Test Execution Guidance:**
Run with: `cargo test windows_process_spawn -- --ignored`

**File Structure:**
- Module header with documentation
- Imports at module level
- 9 integration tests, each 30-50 lines
- Each test uses async/await and tokio primitives
- Total file: ~437 lines (as promised in 04-02 SUMMARY)
  </action>
  <verify>
Run `cargo test windows_process_spawn -- --ignored` and verify:
1. File compiles without errors
2. All 9 tests are discovered
3. Tests execute without hanging
4. No compilation errors about AsyncBufReadExt, Result types, or AsyncWriter
5. Manual verification shows no zombie processes after test run (tasklist | findstr cmd)
  </verify>
  <done>Integration tests for Windows process spawning compile and run, validating XP-01 through 9 realistic scenarios (CLI, concurrency, timeouts, daemon, batch, errors).</done>
</task>

</tasks>

<verification>
- Integration test file tests/windows_process_spawn_tests.rs exists and compiles
- All 9 test functions are present and marked with #[tokio::test] and #[ignore]
- No compilation errors related to AsyncBufReadExt import or AsyncWriter
- Tests execute without hanging (timeout behavior tested)
- Test run completes within acceptable time (each test < 10 seconds total)
  </verification>

<success_criteria>
1. Missing integration test file created matching 04-02-PLAN.md specifications
2. All 9 test scenarios implemented correctly with proper tokio usage
3. Tests compile on Windows without errors (AsyncBufReadExt imported, proper Result types)
4. XP-01 validated through coverage of realistic process lifecycle scenarios
5. Both Windows test files (unit + integration) now exist and compile correctly
</success_criteria>

<output>
After completion, create `.planning/phases/08-fix-windows-tests/08-01-SUMMARY.md`
</output>
