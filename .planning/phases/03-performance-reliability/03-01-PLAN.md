---
phase: 03-performance-reliability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - src/config/mod.rs
  - src/output.rs
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Config struct has new fields: concurrency_limit, retry_max, retry_delay, timeout"
    - "Config struct has default values: concurrency_limit=5, retry_max=3, retry_delay_ms=1000, timeout_secs=1800"
    - "Colored output automatically enabled when stdout is TTY and NO_COLOR not set"
    - "Error messages can be printed with or without colors based on environment"
  artifacts:
    - path: "Cargo.toml"
      provides: "colored and backoff dependencies"
      contains: 'colored = "3.1"'
    - path: "src/config/mod.rs"
      provides: "Performance config fields"
      contains: "pub concurrency_limit: usize"
    - path: "src/output.rs"
      provides: "Colored output utilities"
      exports: ["use_color", "print_error", "print_warning", "print_success", "print_info"]
  key_links:
    - from: "src/config/mod.rs"
      to: "src/retry.rs"
      via: "RetryConfig struct"
      pattern: "RetryConfig::from_config.*Config"
    - from: "src/output.rs"
      to: "src/cli/commands.rs"
      via: "print_error/print_warning/print_success imports"
      pattern: "use crate::output::"
---

<objective>
Extend configuration system with performance settings and create colored output infrastructure.

Purpose: Add necessary configuration fields (concurrency limits, retry behavior, timeouts) and establish terminal output formatting utilities that respect NO_COLOR and TTY detection. This foundation is required by all subsequent plans (parallel execution, retry logic, CLI integration).

Output: Updated Config struct with performance fields, output.rs module with colored utilities, Cargo.toml with colored and backoff dependencies.
</objective>

<execution_context>
@.opencode/get-shit-done/workflows/execute-plan.md
@.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
@.planning/ROADMAP.md
@.planning/phases/03-performance-reliability/03-RESEARCH.md
@src/config/mod.rs
@Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Add dependencies to Cargo.toml (colored, backoff)</name>
  <files>Cargo.toml</files>
  <action>Add two new dependencies to Cargo.toml:

1. Add `colored` crate for terminal output:
```toml
colored = "3.1"
```

2. Add `backoff` crate with tokio feature for retry logic:
```toml
backoff = { version = "0.4", features = ["tokio"] }
```

Place these in the `[dependencies]` section after existing dependencies. Do NOT modify any other sections (target-specific dependencies, bins, dev-dependencies).

Use these specific versions:
- colored = "3.1" (per research: simple API, 10M+ downloads/month)
- backoff = { version = "0.4", features = ["tokio"] } (per research: includes jitter, cancel-safety)</action>
  <verify>Run `cargo check` to verify dependencies resolve without conflicts.</verify>
  <done>Cargo.toml contains colored and backoff dependencies at specified versions, `cargo check` succeeds.</done>
</task>

<task type="auto">
  <name>Extend Config struct with performance fields</name>
  <files>src/config/mod.rs</files>
  <action>Modify the Config struct in src/config/mod.rs to add these new fields:

1. Add at the end of the Config struct (before closing brace):
```rust
/// Maximum concurrent operations for parallel execution (DISC-05)
#[serde(default = "default_concurrency_limit")]
pub concurrency_limit: usize,

/// Maximum retry attempts for transient errors (EXEC-07)
#[serde(default = "default_retry_max")]
pub retry_max: u32,

/// Base delay in milliseconds for exponential backoff (EXEC-07)
#[serde(default = "default_retry_delay_ms")]
pub retry_delay_ms: u64,

/// Overall operation timeout in seconds (EXEC-06)
#[serde(default = "default_timeout_secs")]
pub timeout_secs: u64,
```

2. Add the default functions before the impl Config block (after ServerTransport impl block ends):
```rust
fn default_concurrency_limit() -> usize { 5 }
fn default_retry_max() -> u32 { 3 }
fn default_retry_delay_ms() -> u64 { 1000 }
fn default_timeout_secs() -> u64 { 1800 }
```

3. Derive Default trait for Config (if not already present):
Add `#[derive(Default)]` before `impl Config` to enable default values.

These defaults match the requirements: DISC-05 (concurrency limit 5), EXEC-07 (max 3 attempts, 1000ms base delay), EXEC-06 (1800s timeout).</action>
  <verify>Run `cargo check` to verify the Config struct compiles with new fields and defaults. Check that Config can be deserialized from TOML (serde derives should handle this).</verify>
  <done>Config struct has concurrency_limit, retry_max, retry_delay_ms, timeout_secs fields with correct defaults, code compiles.</done>
</task>

<task type="auto">
  <name>Create colored output utilities module</name>
  <files>src/output.rs</files>
  <action>Create a new file src/output.rs with these utilities:

```rust
//! Colored terminal output utilities.
//!
//! Provides functions for printing colored messages that respect NO_COLOR
//! environment variable and TTY detection. Implements ERR-04.

use std::io::IsTerminal;

/// Check if colored output should be used.
///
/// Returns true if stdout is a TTY and NO_COLOR is not set.
/// This implements ERR-04: colored output when appropriate.
pub fn use_color() -> bool {
    // NO_COLOR environment variable takes precedence (NO_COLOR standard)
    if std::env::var("NO_COLOR").is_ok() {
        return false;
    }

    // Only use colors if stdout is a TTY
    std::io::stdout().is_terminal()
}

/// Print an error message to stderr with appropriate coloring.
///
/// Uses red color when use_color() is true, otherwise plain text.
pub fn print_error(message: &str) {
    if use_color() {
        eprintln!("{}: {}", "Error".red(), message);
    } else {
        eprintln!("Error: {}", message);
    }
}

/// Print a warning message to stderr with appropriate coloring.
///
/// Uses yellow color when use_color() is true, otherwise plain text.
pub fn print_warning(message: &str) {
    if use_color() {
        eprintln!("{}: {}", "Warning".yellow(), message);
    } else {
        eprintln!("Warning: {}", message);
    }
}

/// Print a success message to stdout with appropriate coloring.
///
/// Uses green color when use_color() is true, otherwise plain text.
pub fn print_success(message: &str) {
    if use_color() {
        println!("{}: {}", "Success".green(), message);
    } else {
        println!("Success: {}", message);
    }
}

/// Print an info message to stdout with appropriate coloring.
///
/// Uses cyan color when use_color() is true, otherwise plain text.
pub fn print_info(message: &str) {
    if use_color() {
        println!("{}", message.cyan());
    } else {
        println!("{}", message);
    }
}
```

Also add this module to src/lib.rs (create/mod if missing):
```rust
pub mod output;
```

This provides a clean API for colored output that respects user preferences.</action>
  <verify>Run `cargo check` to verify the output module compiles and is accessible via lib.rs. Test that `cargo test` passes if there are unit tests (none expected yet).</verify>
  <done>src/output.rs exists with use_color, print_error, print_warning, print_success, print_info functions, module exported in lib.rs, code compiles.</done>
</task>

</tasks>

<verification>
Run `cargo check` to verify all changes compile together:
- Cargo.toml dependencies resolve (colored, backoff)
- Config struct with new fields and defaults
- output.rs module with colored utilities
- lib.rs exports output module

Expected: No compilation errors, all new types and functions available.
</verification>

<success_criteria>
1. Cargo.toml includes colored = "3.1" and backoff = { version = "0.4", features = ["tokio"] }
2. Config struct has concurrency_limit (default 5), retry_max (default 3), retry_delay_ms (default 1000), timeout_secs (default 1800) fields
3. src/output.rs provides use_color(), print_error(), print_warning(), print_success(), print_info() functions
4. Code compiles: `cargo check` succeeds
5. Config can be deserialized from TOML with optional fields (serde defaults applied when not specified)
</success_criteria>

<output>
After completion, create `.planning/phases/03-performance-reliability/03-01-SUMMARY.md`
</output>
