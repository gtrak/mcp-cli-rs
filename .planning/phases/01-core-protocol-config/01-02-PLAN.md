---
phase: 01-core-protocol-config
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/config/mod.rs, src/config/loader.rs]
autonomous: true

must_haves:
  truths:
    - "mcp_servers.toml can be parsed with stdio and HTTP server definitions"
    - "Config search order follows priority (env var, CLI arg, current dir, home dir, .config/mcp/)"
    - "Missing or invalid config files display clear error messages"
    - "Warning displayed when no servers configured (CONFIG-05)"
  artifacts:
    - path: "src/config/mod.rs"
      provides: "Configuration module exports"
      min_lines: 20
    - path: "src/config/loader.rs"
      provides: "TOML config file parsing"
      min_lines: 100
  key_links:
    - from: "src/config/loader.rs"
      to: "src/error.rs"
      via: "McpError usage"
      pattern: "use crate::error::McpError"
---

<objective>
Parse and validate server configuration from mcp_servers.toml with intelligent search order.

Purpose: Enable users to configure MCP servers via TOML with stdio and HTTP transport definitions.
Output: Working config loader that discovers, parses, and validates server configurations.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-core-protocol-config/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create configuration data structures</name>
  <files>src/config/mod.rs</files>
  <action>
  Create src/config/mod.rs with configuration types that support both stdio and HTTP transports.

  Create ServerTransport enum with:
  - Stdio variant with fields: command, args, env, cwd (CONFIG-01, CONN-04)
  - Http variant with fields: url, headers (CONFIG-01, CONN-02)

  Create ServerConfig struct with:
  - name: String (server identifier)
  - transport: ServerTransport (transport configuration)
  - description: Option<String> (optional display text)
  - allowed_tools, disabled_tools: Option<Vec<String>> (for Phase 4, FILT-01, FILT-02)

  Create Config struct with:
  - servers: Vec<ServerConfig>

  Implement helper methods:
  - servers_by_name(): Returns HashMap<String, &ServerConfig>
  - get_server(name): Returns Option<&ServerConfig>
  - is_empty(): Returns bool (CONFIG-05)

  Use serde derive macros for Deserialize. Use std::collections::HashMap.

  Note: CONFIG-03 (env var overrides) is deferred to Phase 3 per RESEARCH.md - using layered config instead.
  </action>
  <verify>cargo check</verify>
  <done>Configuration types compile with serde derives</done>
</task>

<task type="auto">
  <name>Task 2: Implement config file discovery and loading</name>
  <files>src/config/loader.rs</files>
  <action>
  Create src/config/loader.rs with config file search and loading functions.

  Create find_config_path(cli_path) function implementing CONFIG-02 priority order:
  1. MCP_CONFIG_PATH environment variable
  2. CLI -c/--config argument
  3. ./mcp_servers.toml (current directory)
  4. ~/.mcp_servers.toml (home directory)
  5. ~/.config/mcp/mcp_servers.toml (config directory)

  Use dirs crate (v5.0) for finding home and config directories.

  Create load_config(path) async function:
  - Use tokio::fs::read_to_string for async file reading (XP-03)
  - Parse TOML using toml crate (v0.8)
  - Validate server definitions:
    - Stdio transport: command field is required (CONFIG-04)
    - Http transport: url field is required (CONFIG-04)
  - Display warning if no servers configured (CONFIG-05)
  - Return error with clear message if config not found

  Create validate_server_config(server, config_path) helper function:
  - Check stdio: command is not empty (CONFIG-04)
  - Check http: url is not empty and is valid URL (CONFIG-04)

  Create find_and_load(cli_path) function that combines find and load.

  Error handling (CONFIG-04):
  - Use McpError::ConfigReadError for file read failures
  - Use McpError::ConfigParseError for TOML parse failures
  - Use McpError::MissingRequiredField for validation failures
  - Include which locations were checked in error messages

  Update Cargo.toml dependencies:
  - Add dirs = "5.0"
  - Add toml = "0.8"
  </action>
  <verify>Add dependencies to Cargo.toml and run cargo check</verify>
  <done>Config discovery and loading compile correctly</done>
</task>

</tasks>

<verification>
1. cargo check passes
2. find_config_path correctly prioritizes locations
3. load_config parses valid stdio and HTTP configs
4. validate_server_config enforces required fields
5. Warning displayed for empty server list
</verification>

<success_criteria>
- mcp_servers.toml can be parsed with stdio (command, args, env, cwd) and HTTP (url, headers) server definitions
- Config search follows priority order (CONFIG-02)
- Clear error messages for missing files and invalid TOML (CONFIG-04)
- Warning displayed when no servers configured (CONFIG-05)
- Uses tokio::fs for async file reading (XP-03)
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-protocol-config/01-02-SUMMARY.md`
</output>
