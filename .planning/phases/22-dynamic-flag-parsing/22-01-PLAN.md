---
phase: 22-dynamic-flag-parsing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cli/command_router.rs
  - src/cli/call.rs
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can call tool with --key value syntax"
    - "User can call tool with --key=value syntax"
    - "User can call tool with --key JSON_VALUE syntax"
    - "Backward compatible with JSON argument"
  artifacts:
    - path: "src/cli/command_router.rs"
      provides: "Modified Call command with dynamic flag support"
      min_lines: 20
    - path: "src/cli/call.rs"
      provides: "Updated argument parsing logic"
      min_lines: 15
  key_links:
    - from: "command_router.rs::Call"
      to: "call.rs::cmd_call_tool"
      via: "args parsing"
      pattern: "dynamic.*args|parse.*flag"
---

<objective>
Implement dynamic flag parsing for the `mcp call` command to support `--key value` syntax.

Purpose: Enable bash-style argument passing for easier CLI usage while maintaining backward compatibility.
Output: Modified call command that parses --key value into JSON fields.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/22-dynamic-flag-parsing/22-RESEARCH.md
@src/cli/command_router.rs
@src/cli/call.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Modify Call command to support dynamic flags</name>
  <files>src/cli/command_router.rs</files>
  <action>
    Modify the `Call` command variant (lines 95-103) to support dynamic flag parsing:
    
    1. Change `args: Option<String>` to accept remaining arguments
    2. Use clap's `#[arg(last = true, allow_hyphen_values = true)]` or similar
    3. The tool should remain the first positional argument
    4. All remaining arguments after tool should be captured for dynamic parsing
    
    Example structure:
    ```rust
    Call {
        /// Tool identifier (server/tool or server tool)
        #[arg(value_name = "TOOL")]
        tool: String,
        
        /// Arguments: either JSON or --key value pairs
        #[arg(last = true, allow_hyphen_values = true)]
        args: Vec<String>,
    }
    ```
    
    Keep the command description updated to reflect new capability.
  </action>
  <verify>
    Run `cargo check` to ensure the change compiles
  </verify>
  <done>
    Call command accepts remaining args as Vec<String> instead of Option<String>
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement dynamic argument parsing in call.rs</name>
  <files>src/cli/call.rs</files>
  <action>
    Update `cmd_call_tool` function signature and parsing logic:
    
    1. Change `args_json: Option<&str>` to `args: Vec<String>`
    2. Implement parsing logic:
       - If args is empty → read from stdin (backward compatible)
       - If args contains JSON only → parse as JSON (backward compatible)
       - If args contains -- prefixed items → parse as dynamic flags:
         - `--key value` → `{"key": "value"}`
         - `--key=value` → `{"key": "value"}`
         - `--key {"a":1}` → parse JSON value directly → `{"key": {"a": 1}}`
    
    Helper function to add to call.rs:
    ```rust
    fn parse_arguments(args: Vec<String>) -> Result<serde_json::Value> {
        // Implementation:
        // 1. If empty, return empty object {}
        // 2. If first arg starts with { → parse as JSON (backward compat)
        // 3. Otherwise parse as --key [value] pairs
        //    - Handle --key=value (equals separator)
        //    - Handle --key value (space separator)
        //    - Handle --key {"a":1} (JSON value)
    }
    ```
  </action>
  <verify>
    Run `cargo check` to ensure the change compiles
  </verify>
  <done>
    Function parses dynamic flags into JSON object correctly
  </done>
</task>

<task type="auto">
  <name>Task 3: Run tests and verify functionality</name>
  <files>src/cli/call.rs</files>
  <action>
    1. Run existing tests: `cargo test --lib`
    2. Manually test the new syntax:
       - `cargo run -- call server/tool --path /tmp/file.txt`
       - `cargo run -- call server/tool --path=/tmp/file.txt`
       - `cargo run -- call server/tool --options '{"a":1}'`
       - `cargo run -- call server/tool '{"key": "value"}'` (backward compat)
    3. Ensure all tests pass
  </action>
  <verify>
    `cargo test --lib` passes and manual tests work
  </verify>
  <done>
    All tests pass and new syntax works as expected
  </done>
</task>

</tasks>

<verification>
1. Check: `cargo test --lib` passes
2. Check: `--key value` produces correct JSON
3. Check: `--key=value` produces correct JSON
4. Check: `--key {"a":1}` produces correct nested JSON
5. Check: backward compatible with JSON argument
</verification>

<success_criteria>
- [ ] ARGS-01: `--key value` parsed as `{"key": "value"}`
- [ ] ARGS-02: `--key=value` parsed as `{"key": "value"}`
- [ ] ARGS-03: `--key {"a":1}` parsed as `{"key": {"a": 1}}`
- [ ] ARGS-04: backward compatible with JSON argument
- [ ] All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/22-dynamic-flag-parsing/22-01-SUMMARY.md`
</output>
